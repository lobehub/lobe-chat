@chat @knowledge
Feature: 知识库功能
  测试知识库和文件关联功能

  Background:
    Given 应用正在运行

  # ============================================
  # 知识库面板
  # ============================================

  @CHAT-KB-001 @P1
  Scenario: 打开知识库面板
    Given 我访问 "/chat"
    When 我点击知识库按钮
    Then 应该打开知识库面板
    And 我应该看到文件/知识库选项

  @CHAT-KB-002 @P1
  Scenario: 查看知识库列表
    Given 我访问 "/chat"
    And 我已经打开知识库面板
    Then 我应该看到所有知识库
    And 我应该看到所有文件

  # ============================================
  # 关联知识库
  # ============================================

  @CHAT-KB-003 @P1
  Scenario: 关联知识库到会话
    Given 我访问 "/chat"
    When 我点击知识库按钮
    And 我选择一个知识库
    And 我点击添加按钮
    Then 知识库应该被关联
    And 我应该看到关联的知识库标记
    And 聊天应该能访问该知识库内容

  @CHAT-KB-004 @P1
  Scenario: 关联多个知识库
    Given 我访问 "/chat"
    When 我选择多个知识库
    And 我点击添加按钮
    Then 所有知识库应该被关联
    And 我应该看到多个知识库标记

  @CHAT-KB-005 @P1
  Scenario: 移除知识库关联
    Given 我访问 "/chat"
    And 已经关联了一个知识库
    When 我点击知识库标记的删除按钮
    And 我确认移除
    Then 知识库关联应该被移除
    And 知识库标记应该消失

  # ============================================
  # 关联文件
  # ============================================

  @CHAT-KB-006 @P1
  Scenario: 关联文件到会话
    Given 我访问 "/chat"
    When 我点击知识库按钮
    And 我切换到所有文件标签
    And 我选择一个文件
    And 我点击添加按钮
    Then 文件应该被关联
    And 我应该看到关联的文件标记

  @CHAT-KB-007 @P1
  Scenario: 关联多个文件
    Given 我访问 "/chat"
    When 我选择多个文件
    And 我点击添加按钮
    Then 所有文件应该被关联
    And 我应该看到多个文件标记

  @CHAT-KB-008 @P1
  Scenario: 移除文件关联
    Given 我访问 "/chat"
    And 已经关联了一个文件
    When 我点击文件标记的删除按钮
    And 我确认移除
    Then 文件关联应该被移除
    And 文件标记应该消失

  # ============================================
  # 文件上传
  # ============================================

  @CHAT-KB-009 @P1
  Scenario: 上传文件到知识库
    Given 我访问 "/chat"
    When 我通过输入框上传一个文件
    Then 文件应该上传成功
    And 应该显示上传成功提示
    And 我应该看到"上传过的文件可以在「知识库」中查看"提示

  @CHAT-KB-010 @P1
  Scenario: 查看上传文件的详情
    Given 我访问 "/chat"
    And 我已经上传了一个文件
    When 我点击文件详情按钮
    Then 应该显示文件详细信息
    And 我应该看到文件大小、类型等信息

  # ============================================
  # 查看引用源
  # ============================================

  @CHAT-KB-011 @P1
  Scenario: 查看 RAG 引用源
    Given 我访问 "/chat"
    And 已经关联了知识库
    And AI 回复使用了知识库内容
    When 我点击引用源按钮
    Then 应该显示引用的内容块
    And 我应该看到引用来源
    And 应该显示引用的具体文本

  @CHAT-KB-012 @P1
  Scenario: 查看用户查询重写
    Given 我访问 "/chat"
    And 使用了 RAG 搜索
    When 我展开查询详情
    Then 我应该看到用户查询重写内容
    And 应该显示原始查询和优化后的查询

  @CHAT-KB-013 @P1
  Scenario: 删除查询重写
    Given 我访问 "/chat"
    And 存在查询重写记录
    When 我点击删除 Query 重写按钮
    And 我确认删除
    Then 查询重写应该被删除

  # ============================================
  # 知识库搜索
  # ============================================

  @CHAT-KB-014 @P2
  Scenario: 搜索知识库
    Given 我访问 "/chat"
    And 知识库面板已打开
    When 我在搜索框中输入关键词
    Then 应该显示匹配的知识库
    And 应该显示匹配的文件

  # ============================================
  # 查看更多
  # ============================================

  @CHAT-KB-015 @P2
  Scenario: 查看更多知识库
    Given 我访问 "/chat"
    And 知识库面板已打开
    When 我点击查看更多按钮
    Then 应该跳转到知识库管理页面
    And 我应该看到所有知识库和文件

  # ============================================
  # 知识库标记显示
  # ============================================

  @CHAT-KB-016 @P1
  Scenario: 在聊天头部显示知识库标记
    Given 我访问 "/chat"
    And 已经关联了知识库
    Then 我应该在聊天头部看到知识库标记
    And 标记应该显示关联的知识库数量

  @CHAT-KB-017 @P1
  Scenario: 点击知识库标记查看详情
    Given 我访问 "/chat"
    And 聊天头部显示知识库标记
    When 我点击知识库标记
    Then 应该显示关联的知识库列表
    And 我应该能查看详情或移除关联

  # ============================================
  # 部署模式限制
  # ============================================

  @CHAT-KB-018 @P2
  Scenario: 客户端模式下知识库不可用
    Given 我访问 "/chat"
    And 当前是客户端数据库模式
    When 我点击知识库按钮
    Then 应该显示不支持提示
    And 应该提示切换到服务端数据库部署

  # ============================================
  # 关联文件/知识库显示
  # ============================================

  @CHAT-KB-019 @P1
  Scenario: 查看关联的文件和知识库
    Given 我访问 "/chat"
    And 已经关联了文件和知识库
    When 我打开知识库面板
    Then 关联的项应该显示已添加标记
    And 我应该能区分已关联和未关联的项
