@chat @message
Feature: 消息交互
  测试聊天消息的发送、接收和各种操作功能

  Background:
    Given 应用正在运行

  # ============================================
  # 消息发送
  # ============================================

  @CHAT-MESSAGE-001 @P0
  Scenario: 发送文本消息
    Given 我访问 "/chat"
    When 我在输入框中输入 "你好"
    And 我点击发送按钮
    Then 消息应该发送成功
    And 我应该在聊天列表中看到我的消息
    And AI 应该开始回复

  @CHAT-MESSAGE-002 @P0
  Scenario: 使用快捷键发送消息
    Given 我访问 "/chat"
    When 我在输入框中输入 "测试消息"
    And 我按下 Enter 键
    Then 消息应该发送成功
    And 我应该看到消息已发送

  @CHAT-MESSAGE-003 @P1
  Scenario: 多行消息输入
    Given 我访问 "/chat"
    When 我在输入框中输入 "第一行"
    And 我按下 Shift+Enter 换行
    And 我输入 "第二行"
    And 我点击发送按钮
    Then 消息应该包含两行内容

  # ============================================
  # 接收消息
  # ============================================

  @CHAT-MESSAGE-004 @P0
  Scenario: 接收 AI 回复
    Given 我访问 "/chat"
    And 我已经发送了一条消息
    Then 我应该看到 AI 正在思考的状态
    And 我应该看到 AI 的回复消息流式输出
    And 消息生成完成后应该显示完整内容

  @CHAT-MESSAGE-005 @P1
  Scenario: 查看消息详情
    Given 我访问 "/chat"
    And 存在一条 AI 回复消息
    When 我点击消息底部的详情按钮
    Then 应该展开消息详情
    And 我应该看到 Token 使用统计
    And 我应该看到生成速度信息

  # ============================================
  # 停止生成
  # ============================================

  @CHAT-MESSAGE-006 @P1
  Scenario: 停止消息生成
    Given 我访问 "/chat"
    And AI 正在生成回复
    When 我点击停止按钮
    Then AI 应该停止生成
    And 应该显示已生成的部分内容
    And 发送按钮应该恢复可用状态

  # ============================================
  # 重新生成
  # ============================================

  @CHAT-MESSAGE-007 @P1
  Scenario: 重新生成 AI 回复
    Given 我访问 "/chat"
    And 存在一条 AI 回复消息
    When 我悬停在消息上
    And 我点击重新生成按钮
    Then AI 应该重新生成回复
    And 旧的回复应该被替换

  @CHAT-MESSAGE-008 @P1
  Scenario: 删除并重新生成
    Given 我访问 "/chat"
    And 存在一条 AI 回复消息
    When 我悬停在消息上
    And 我点击删除并重新生成按钮
    Then 该消息应该被删除
    And AI 应该重新生成回复

  # ============================================
  # 编辑消息
  # ============================================

  @CHAT-MESSAGE-009 @P1
  Scenario: 编辑用户消息
    Given 我访问 "/chat"
    And 存在一条我发送的消息
    When 我悬停在消息上
    And 我点击编辑按钮
    And 我修改消息内容
    And 我保存编辑
    Then 消息内容应该更新
    And AI 应该根据新内容重新回复

  # ============================================
  # 删除消息
  # ============================================

  @CHAT-MESSAGE-010 @P1
  Scenario: 删除单条消息
    Given 我访问 "/chat"
    And 存在一条消息
    When 我悬停在消息上
    And 我点击删除按钮
    And 我确认删除
    Then 该消息应该被删除
    And 消息列表中不应该再显示该消息

  @CHAT-MESSAGE-011 @P1
  Scenario: 无法删除有子话题的消息
    Given 我访问 "/chat"
    And 存在一条有子话题的消息
    When 我悬停在消息上
    Then 删除按钮应该被禁用
    And 应该显示禁用原因提示

  # ============================================
  # 复制消息
  # ============================================

  @CHAT-MESSAGE-012 @P1
  Scenario: 复制消息内容
    Given 我访问 "/chat"
    And 存在一条消息
    When 我悬停在消息上
    And 我点击复制按钮
    Then 消息内容应该被复制到剪贴板
    And 应该显示复制成功提示

  # ============================================
  # 清空消息
  # ============================================

  @CHAT-MESSAGE-013 @P1
  Scenario: 清空当前会话消息
    Given 我访问 "/chat"
    And 当前会话存在多条消息
    When 我点击清空消息按钮
    And 我确认清空
    Then 所有消息应该被删除
    And 应该显示清空成功提示

  # ============================================
  # 消息跳转
  # ============================================

  @CHAT-MESSAGE-014 @P2
  Scenario: 跳转到最新消息
    Given 我访问 "/chat"
    And 消息列表很长
    And 我滚动到历史消息位置
    When 我点击跳转到当前按钮
    Then 页面应该滚动到最新消息
    And 最新消息应该可见

  # ============================================
  # 消息小地图导航
  # ============================================

  @CHAT-MESSAGE-015 @P2
  Scenario: 使用消息小地图导航
    Given 我访问 "/chat"
    And 存在多条消息
    When 我点击小地图上的某个消息点
    Then 页面应该跳转到对应的消息
    And 该消息应该高亮显示
