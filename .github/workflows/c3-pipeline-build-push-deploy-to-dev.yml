name: Build and Push to ECR


on:
  push:
    branches:
      - main  
  workflow_dispatch:  

jobs:
  build_push:
    runs-on:
      labels: toolsEnv
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3  
        with:
          fetch-depth: 0  # Fetch all history

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Docker build and push
        run: |
          ECR_REGISTRY=606191926999.dkr.ecr.us-east-1.amazonaws.com
          ECR_REPOSITORY=sai-c3-lobechat
          
          # Extract version from package.json (like AWS CodePipeline did)
          VERSION=$(jq -r '.version' package.json)
          SHORT_SHA="${GITHUB_SHA:0:7}"
          
          # Tag format: dev-VERSION-SHORT_SHA (e.g., dev-1.143.2-a1b2c3d)
          image="dev-${VERSION}-${SHORT_SHA}"
          
          echo "Building Docker image with tag: ${image}"
          echo "Version from package.json: ${VERSION}"
          echo "Commit SHA: ${SHORT_SHA}"
          
          docker build . -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${image}
          
          echo "Pushing Docker image to ECR..."
          docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${image}
          
          echo "Build completed successfully"
          echo "Image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${image}"
