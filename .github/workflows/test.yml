name: Test CI

on: [push, pull_request]

permissions:
  contents: read

jobs:
  # Package tests - using each package's own test script
  test-intenral-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - file-loaders
          - prompts
          - model-runtime
          - web-crawler
          - electron-server-ipc
          - utils
          - python-interpreter
          - context-engine
          - agent-runtime
          - conversation-flow

    name: Test package ${{ matrix.package }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install deps
        run: bun i

      - name: Test ${{ matrix.package }} package with coverage
        run: bun run --filter @lobechat/${{ matrix.package }} test:coverage

      - name: Upload ${{ matrix.package }} coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/${{ matrix.package }}/coverage/lcov.info
          flags: packages/${{ matrix.package }}

  test-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [model-bank]

    name: Test package ${{ matrix.package }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.23

      - name: Install deps
        run: bun i

      - name: Test ${{ matrix.package }} package with coverage
        run: bun run --filter ${{ matrix.package }} test:coverage

      - name: Upload ${{ matrix.package }} coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/${{ matrix.package }}/coverage/lcov.info
          flags: packages/${{ matrix.package }}

  # App tests
  test-website:
    name: Test Website

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.23

      - name: Install deps
        run: bun i

      - name: Test App Coverage
        run: bun run test-app:coverage

      - name: Upload App Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/app/lcov.info
          flags: app

  test-desktop:
    name: Test Desktop App

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install deps
        run: pnpm install
        working-directory: apps/desktop
        env:
          NODE_OPTIONS: --max-old-space-size=6144


      - name: Test Desktop Client
        run: pnpm test
        working-directory: apps/desktop

      - name: Upload Desktop App Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./apps/desktop/coverage/lcov.info
          flags: desktop

  test-databsae:
    name: Test Database

    runs-on: ubuntu-latest

    services:
      postgres:
        image: paradedb/paradedb:latest
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s  --health-retries 5

        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install deps
        run: pnpm i

      - name: Lint
        run: npm run lint

      - name: Test Client DB
        run: pnpm --filter @lobechat/database test:client-db
        env:
          KEY_VAULTS_SECRET: Kix2wcUONd4CX51E/ZPAd36BqM4wzJgKjPtz2sGztqQ=
          S3_PUBLIC_DOMAIN: https://example.com
          APP_URL: https://home.com

      - name: Test Coverage
        run: pnpm --filter @lobechat/database test:coverage
        env:
          DATABASE_TEST_URL: postgresql://postgres:postgres@localhost:5432/postgres
          DATABASE_DRIVER: node
          KEY_VAULTS_SECRET: Kix2wcUONd4CX51E/ZPAd36BqM4wzJgKjPtz2sGztqQ=
          S3_PUBLIC_DOMAIN: https://example.com
          APP_URL: https://home.com

      - name: Upload Database coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/database/coverage/lcov.info
          flags: database
