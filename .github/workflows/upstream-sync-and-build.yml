name: Upstream Sync and Build Docker

permissions:
  contents: write   # æ¨é€åŒæ­¥ä»£ç 
  issues: write     # åŒæ­¥å¤±è´¥æ—¶åˆ›å»º issue
  # å¦‚æœä½ æ¨ GHCR è¿˜éœ€è¦ packages: write

on:
  schedule:
    - cron: '0 */6 * * *'   # æ¯ 6 å°æ—¶è¿è¡Œ
  workflow_dispatch:

jobs:
  sync_and_build:
    name: Sync Upstream (default branch) and Build Docker Image
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}  # ä»…åœ¨ fork ä»“åº“ä¸­è¿è¡Œ

    steps:
      # 1) æ£€å‡ºå½“å‰ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) è¯»å–ä¸Šæ¸¸ä»“åº“çš„ default branchï¼ˆå¤±è´¥å…œåº•ä¸º mainï¼‰
      - name: Detect upstream default branch
        id: upstream
        uses: actions/github-script@v7
        with:
          script: |
            const repo = 'lobehub/lobe-chat';
            const [owner, name] = repo.split('/');
            try {
              const { data } = await github.rest.repos.get({ owner, repo: name });
              core.info(`Upstream default branch: ${data.default_branch}`);
              core.setOutput('default_branch', data.default_branch);
            } catch (e) {
              core.warning(`Failed to get default branch, fallback to 'main': ${e.message}`);
              core.setOutput('default_branch', 'main');
            }

      # 3) æ¸…ç†æ—§çš„â€œåŒæ­¥å¤±è´¥â€ issue æç¤º
      - name: Clean issue notice
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issues'
          labels: 'ğŸš¨ Sync Fail'

      # 4) æ‰§è¡Œä¸Šæ¸¸åŒæ­¥ï¼ˆä»â€œä¸Šæ¸¸ default branchâ€åˆ°â€œæœ¬ä»“åº“åŒååˆ†æ”¯â€ï¼‰
      - name: Sync upstream changes (track upstream default branch)
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: lobehub/lobe-chat
          upstream_sync_branch: ${{ steps.upstream.outputs.default_branch }}
          target_sync_branch:  ${{ steps.upstream.outputs.default_branch }}
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          test_mode: false

      # 5) å¦‚åŒæ­¥å¤±è´¥åˆ™åˆ›å»º issue
      - name: Sync check
        if: failure() && steps.sync.outcome == 'failure'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å¤±è´¥ | Sync Fail'
          labels: 'ğŸš¨ Sync Fail'
          body: |
            åŒæ­¥ä¸Šæ¸¸ä»“åº“ lobehub/lobe-chat æ—¶å‘ç”Ÿé”™è¯¯ã€‚è¯·æ£€æŸ¥ Action æ—¥å¿—æˆ–æ‰‹åŠ¨åŒæ­¥ã€‚
            Error occurred while syncing with upstream repository lobehub/lobe-chat. Please check Action logs or sync manually.
            [lobechat]: https://github.com/lobehub/lobe-chat
            [tutorial-zh-CN]: https://github.com/lobehub/lobe-chat/wiki/Upstream-Sync.zh-CN
            [tutorial-en-US]: https://github.com/lobehub/lobe-chat/wiki/Upstream-Sync

      # --- Docker æ„å»ºä¸æ¨é€ï¼Œä»…åœ¨æœ‰æ–°æäº¤æ—¶æ‰§è¡Œ ---
      # åˆ‡æ¢åˆ°åˆšåŒæ­¥çš„åˆ†æ”¯è¿›è¡Œæ„å»º
      - name: Switch to synced branch
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        run: |
          git checkout "${{ steps.upstream.outputs.default_branch }}"
          echo "Switched to branch: ${{ steps.upstream.outputs.default_branch }}"
          git log --oneline -n 5

      - name: Set up Docker Buildx
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/metadata-action@v5
        with:
          images: marvinlee514/lobechat-docker-clerk
          tags: |
            # å§‹ç»ˆæ¨ latest
            type=raw,value=latest
            # é¢å¤–åŠ ä¸€ä¸ªâ€œåˆ†æ”¯åâ€æ ‡ç­¾ï¼Œä¾‹å¦‚ next æˆ– mainï¼Œä¾¿äºåŒºåˆ†
            type=raw,value=${{ steps.upstream.outputs.default_branch }}
            # å†åŠ ä¸€ä¸ªçŸ­ SHA æ ‡ç­¾
            type=sha,format=short

      - name: Build and push Docker image (amd64)
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          # âš ï¸ ç¡®è®¤ Dockerfile è·¯å¾„æ­£ç¡®
          file: ./Dockerfile.database
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_ARG=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
            CLERK_WEBHOOK_SECRET_ARG=${{ secrets.CLERK_WEBHOOK_SECRET }}
            CLERK_SECRET_KEY_ARG=${{ secrets.CLERK_SECRET_KEY }}
