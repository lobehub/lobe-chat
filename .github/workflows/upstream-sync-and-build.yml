name: Upstream Sync and Build Docker

permissions:
  contents: write # åŒæ­¥åˆ° fork éœ€è¦
  issues: write   # åŒæ­¥å¤±è´¥æ—¶å»º issue
  # å¦‚æœä½ æ¨åˆ° GHCR è¿˜éœ€è¦ packages: write

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  sync_and_build:
    name: Sync Upstream (default branch) and Build Docker
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # 0. è¯»å–ä¸Šæ¸¸ä»“åº“é»˜è®¤åˆ†æ”¯ï¼ˆæ¯”å¦‚ç°åœ¨æ˜¯ nextï¼Œä¹‹åæ”¹å› main ä¹Ÿå¯è‡ªåŠ¨é€‚é…ï¼‰
      - name: Get upstream default branch
        id: get-default
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM_REPO="lobehub/lobe-chat"
          DEFAULT_BRANCH=$(gh api repos/$UPSTREAM_REPO --jq .default_branch)
          echo "branch=$DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"
          echo "repo=$UPSTREAM_REPO" >> "$GITHUB_OUTPUT"
      # 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆè·å–å®Œæ•´å†å²ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. å…³é—­æ—§çš„â€œåŒæ­¥å¤±è´¥â€æç¤º issueï¼ˆå¯é€‰ï¼‰
      - name: Clean issue notice
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issues'
          labels: 'ğŸš¨ Sync Fail'

      - name: Ensure target branch exists
        run: |
          git fetch origin
          if ! git show-ref --verify --quiet refs/heads/${{ steps.get-default.outputs.branch }}; then
            echo "Creating branch ${{ steps.get-default.outputs.branch }}..."
            git checkout -b ${{ steps.get-default.outputs.branch }}
            git push origin ${{ steps.get-default.outputs.branch }}
          else
            echo "Branch ${{ steps.get-default.outputs.branch }} already exists."
          fi
      # 3. æŒ‰â€œä¸Šæ¸¸é»˜è®¤åˆ†æ”¯â€è¿›è¡ŒåŒæ­¥ï¼›ç›®æ ‡åˆ†æ”¯ä¸ä¸Šæ¸¸åˆ†æ”¯åŒåï¼ˆmain->main / next->nextï¼‰
      - name: Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: ${{ steps.get-default.outputs.repo }}
          upstream_sync_branch: ${{ steps.get-default.outputs.branch }}
          target_sync_branch:  ${{ steps.get-default.outputs.branch }}
          target_repo_token:   ${{ secrets.GITHUB_TOKEN }}
          test_mode: false

      # 4. åŒæ­¥å¤±è´¥åˆ™å»º issue
      - name: Sync check
        if: failure() && steps.sync.outcome == 'failure'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å¤±è´¥ | Sync Fail'
          labels: 'ğŸš¨ Sync Fail'
          body: |
            åŒæ­¥ä¸Šæ¸¸ä»“åº“ lobehub/lobe-chat æ—¶å‘ç”Ÿé”™è¯¯ã€‚è¯·æ£€æŸ¥ Action æ—¥å¿—æˆ–æ‰‹åŠ¨åŒæ­¥ã€‚
            Error occurred while syncing with upstream repository lobehub/lobe-chat. Please check Action logs or sync manually.
            [lobechat]: https://github.com/lobehub/lobe-chat
            [tutorial-zh-CN]: https://github.com/lobehub/lobe-chat/wiki/Upstream-Sync.zh-CN
            [tutorial-en-US]: https://github.com/lobehub/lobe-chat/wiki/Upstream-Sync

      # 5. é‡æ–°æ£€å‡ºâ€œåˆšåŒæ­¥çš„ç›®æ ‡åˆ†æ”¯â€ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡ï¼ˆç¡®ä¿ç”¨çš„æ˜¯æœ€æ–°ä»£ç ï¼‰
      - name: Checkout synced branch for build
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-default.outputs.branch }}
          fetch-depth: 0

      # --- Docker æ„å»ºä¸æ¨é€ï¼Œä»…å½“æœ¬æ¬¡ç¡®å®æ‹‰åˆ°æ–°æäº¤ ---
      - name: Set up Docker Buildx
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # è¿™é‡Œçš„åˆ†æ”¯æ ‡ç­¾ä¸ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯ä¿æŒä¸€è‡´ï¼ˆä¾‹å¦‚ next æˆ– mainï¼‰ï¼ŒåŒæ—¶ä¿ç•™ latest
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/metadata-action@v5
        with:
          images: marvinlee514/lobechat-docker-clerk
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.get-default.outputs.branch }}
            type=sha,format=short

      - name: Build and push Docker image (amd64)
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.database   # ç¡®è®¤æ­¤è·¯å¾„åœ¨ä»“åº“ä¸­å­˜åœ¨
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_ARG=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
            CLERK_WEBHOOK_SECRET_ARG=${{ secrets.CLERK_WEBHOOK_SECRET }}
            CLERK_SECRET_KEY_ARG=${{ secrets.CLERK_SECRET_KEY }}
