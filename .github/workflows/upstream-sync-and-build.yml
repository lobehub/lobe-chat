name: Upstream Sync and Build Docker

permissions:
  contents: write # Fork-Sync-With-Upstream-action éœ€è¦å†™æƒé™æ¥æ¨é€åŒæ­¥çš„ä»£ç 
  issues: write   # ç”¨äºåŒæ­¥å¤±è´¥æ—¶åˆ›å»º issue
  # Docker build/push ä¸éœ€è¦ç‰¹æ®Šæƒé™ï¼Œä½† packages:write å¯èƒ½éœ€è¦ï¼ˆå¦‚æœæ¨é€åˆ° GHCR è€Œä¸æ˜¯ Docker Hubï¼‰

on:
  schedule:
    - cron: '0 */6 * * *' # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync_and_build: # å°†ä¸¤ä¸ªä»»åŠ¡åˆå¹¶åˆ°ä¸€ä¸ª job ä¸­
    name: Sync Upstream and Build Docker Image
    runs-on: ubuntu-latest
    # ä»…åœ¨ fork ä»“åº“ä¸­è¿è¡ŒåŒæ­¥é€»è¾‘
    if: ${{ github.event.repository.fork }}

    steps:
      # 1. æ£€å‡ºå½“å‰ fork çš„ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦è·å–å†å²è®°å½•ï¼Œä»¥ä¾¿ aormsby action èƒ½æ­£ç¡®åˆ¤æ–­æ˜¯å¦æœ‰æ–°æäº¤
          fetch-depth: 0

      # 2. æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§çš„åŒæ­¥å¤±è´¥ issue
      - name: Clean issue notice
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issues'
          labels: 'ğŸš¨ Sync Fail'

      # 3. æ‰§è¡Œä¸Šæ¸¸åŒæ­¥
      - name: Sync upstream changes
        id: sync # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ª idï¼Œæ–¹ä¾¿åé¢å¼•ç”¨å®ƒçš„è¾“å‡º
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: lobehub/lobe-chat # ä¸Šæ¸¸ä»“åº“
          upstream_sync_branch: main           # ä¸Šæ¸¸åˆ†æ”¯
          target_sync_branch: main             # åŒæ­¥åˆ°ä½ çš„ fork çš„å“ªä¸ªåˆ†æ”¯
          target_repo_token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ Token
          # fetch-depth: 0 # aormsby action v3.4 é»˜è®¤ä¼šè·å–å®Œæ•´å†å²è®°å½•
          test_mode: false # è®¾ç½®ä¸º false ä»¥å®é™…æ‰§è¡ŒåŒæ­¥

      # 4. æ£€æŸ¥åŒæ­¥æ˜¯å¦æˆåŠŸï¼Œå¦‚æœå¤±è´¥åˆ™åˆ›å»º issue (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
      - name: Sync check
        if: failure() && steps.sync.outcome == 'failure' # ä»…åœ¨ sync æ­¥éª¤æ˜ç¡®å¤±è´¥æ—¶è¿è¡Œ
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å¤±è´¥ | Sync Fail'
          labels: 'ğŸš¨ Sync Fail'
          body: |
            åŒæ­¥ä¸Šæ¸¸ä»“åº“ lobehub/lobe-chat æ—¶å‘ç”Ÿé”™è¯¯ã€‚è¯·æ£€æŸ¥ Action æ—¥å¿—æˆ–æ‰‹åŠ¨åŒæ­¥ã€‚
            Error occurred while syncing with upstream repository lobehub/lobe-chat. Please check Action logs or sync manually.
            [lobechat]: https://github.com/lobehub/lobe-chat
            [tutorial-zh-CN]: https://github.com/lobehub/lobe-chat/wiki/Upstream-Sync.zh-CN
            [tutorial-en-US]: https://github.com/lobehub/lobe-chat/wiki/Upstream-Sync

      # --- Docker æ„å»ºå’Œæ¨é€æ­¥éª¤ ---
      # ä»…åœ¨åŒæ­¥æˆåŠŸ (steps.sync.outcome == 'success')
      # å¹¶ä¸” aormsby action ç¡®è®¤æœ‰æ–°çš„æäº¤è¢«æ‹‰å– (steps.sync.outputs.has_new_commits == 'true') æ—¶è¿è¡Œ
      - name: Set up Docker Buildx
        if: success() && steps.sync.outputs.has_new_commits == 'true' # æ¡ä»¶ï¼šåŒæ­¥æˆåŠŸä¸”æœ‰æ–°æäº¤
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # ä½¿ç”¨ä½ è‡ªå·±çš„ Docker Hub ç”¨æˆ·å Secret
          password: ${{ secrets.DOCKERHUB_TOKEN }}    # ä½¿ç”¨ä½ è‡ªå·±çš„ Docker Hub Token Secret

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/metadata-action@v5
        with:
          # ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„ Docker Hub é•œåƒåç§°
          images: marvinlee514/lobechat-docker-clerk
          tags: |
            type=raw,value=latest # å§‹ç»ˆæ¨é€ latest æ ‡ç­¾
            # å¯ä»¥é€‰æ‹©æ€§åœ°æ·»åŠ åŸºäº commit SHA çš„æ ‡ç­¾
            type=sha,prefix=,suffix=,format=short

      - name: Build and push Docker image (amd64)
        if: success() && steps.sync.outputs.has_new_commits == 'true'
        uses: docker/build-push-action@v5
        with:
          context: . # Docker æ„å»ºä¸Šä¸‹æ–‡ä¸ºä»“åº“æ ¹ç›®å½•
          # ç¡®è®¤ LobeChat æ•°æ®åº“ç‰ˆæœ¬çš„ Dockerfile è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼
          file: ./Dockerfile.database # <--- ç¡®è®¤è¿™ä¸ªè·¯å¾„æ˜¯å¦æ˜¯ LobeChat å®é™…çš„ Dockerfile è·¯å¾„
          platforms: linux/amd64 # åªæ„å»º amd64 å¹³å°
          push: true # æ¨é€é•œåƒ
          tags: ${{ steps.meta.outputs.tags }} # ä½¿ç”¨ metadata action ç”Ÿæˆçš„æ ‡ç­¾
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_ARG=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
            CLERK_WEBHOOK_SECRET_ARG=${{ secrets.CLERK_WEBHOOK_SECRET }} 
            CLERK_SECRET_KEY_ARG=${{ secrets.CLERK_SECRET_KEY }}         
            # SHA=${{ github.sha }} # å¦‚æœéœ€è¦ SHA
