name: Release Desktop

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘æ„å»º
  release:
    types: [published] # å‘å¸ƒ release æ—¶è§¦å‘æ„å»º
  pull_request:
    types: [synchronize, labeled, unlabeled] # PR æ›´æ–°æˆ–æ ‡ç­¾å˜åŒ–æ—¶è§¦å‘

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªç›¸åŒçš„ workflowï¼Œå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æ—§çš„è¿è¡Œ
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  PR_TAG_PREFIX: pr- # PR æ„å»ºç‰ˆæœ¬çš„å‰ç¼€æ ‡è¯†

jobs:
  test:
    name: Code quality check
    # æ·»åŠ  PR label è§¦å‘æ¡ä»¶ï¼Œåªæœ‰æ·»åŠ äº† Build Desktop æ ‡ç­¾çš„ PR æ‰ä¼šè§¦å‘æ„å»º
    if: |
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'Build Desktop')) ||
      github.event_name != 'pull_request'
    runs-on: ubuntu-latest # åªåœ¨ ubuntu ä¸Šè¿è¡Œä¸€æ¬¡æ£€æŸ¥
    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install deps
        run: bun i

      - name: Lint
        run: bun run lint

  version:
    name: Determine version
    # ä¸ test job ç›¸åŒçš„è§¦å‘æ¡ä»¶
    if: |
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'Build Desktop')) ||
      github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œä¾›åç»­ job ä½¿ç”¨
      version: ${{ steps.set_version.outputs.version }}
      is_pr_build: ${{ steps.set_version.outputs.is_pr_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ä¸»è¦é€»è¾‘ï¼šç¡®å®šæ„å»ºç‰ˆæœ¬å·
      - name: Set version
        id: set_version
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR æ„å»ºä½¿ç”¨ç‰¹æ®Šç‰ˆæœ¬å·
            branch_name="${{ github.head_ref }}"
            # æ¸…ç†åˆ†æ”¯åï¼Œç§»é™¤éæ³•å­—ç¬¦
            sanitized_branch=$(echo "${branch_name}" | sed -E 's/[^a-zA-Z0-9_.-]+/-/g')
            # åˆ›å»ºç‰¹æ®Šçš„ PR ç‰ˆæœ¬å·
            echo "version=${{ env.PR_TAG_PREFIX }}${sanitized_branch}-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
            echo "is_pr_build=true" >> $GITHUB_OUTPUT

          elif [ "${{ github.event_name }}" == "release" ]; then
            # Release äº‹ä»¶ç›´æ¥ä½¿ç”¨ release tag ä½œä¸ºç‰ˆæœ¬å·ï¼Œå»æ‰å¯èƒ½çš„ v å‰ç¼€
            version="${{ github.event.release.tag_name }}"
            version="${version#v}"
            echo "version=${version}" >> $GITHUB_OUTPUT
            echo "is_pr_build=false" >> $GITHUB_OUTPUT

          else
            # å…¶ä»–æƒ…å†µï¼ˆå¦‚æ‰‹åŠ¨è§¦å‘ï¼‰ä» package.json è¯»å–å½“å‰ç‰ˆæœ¬å·
            version=$(node -p "require('./package.json').version")
            echo "version=${version}" >> $GITHUB_OUTPUT
            echo "is_pr_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: [version, test]
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ä½¿ç”¨ bun è€Œä¸æ˜¯ pnpm
      - name: Install bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install deps
        run: bun install

      # è®¾ç½® package.json çš„ç‰ˆæœ¬å·
      - name: Set package version
        run: npx npe version ${{ needs.version.outputs.version }}

      # macOS æ„å»ºå¤„ç†
      - name: Build artifact on macOS
        if: runner.os == 'macOS'
        run: bun run build # ä½¿ç”¨ bun æ¥æ„å»º
        # å…¬è¯éƒ¨åˆ†å·²æ³¨é‡Šæ‰ï¼Œå°†æ¥å†åŠ å›
        # env:
        #   CSC_LINK: ./build/developer-id-app-certs.p12
        #   CSC_KEY_PASSWORD: ${{ secrets.APPLE_APP_CERTS_PASSWORD }}
        #   APPLE_ID: ${{ secrets.APPLE_ID }}
        #   APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

      # é macOS å¹³å°æ„å»ºå¤„ç†
      - name: Build artifact on other platforms
        if: runner.os != 'macOS'
        run: bun run build --publish never

      # ä¸Šä¼ æ„å»ºäº§ç‰©ï¼Œç§»é™¤äº† zip ç›¸å…³éƒ¨åˆ†
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: |
            release/latest*
            release/umi*.dmg*
            release/umi*.exe*
            release/umi*.AppImage
          retention-days: 5

  status:
    needs: version
    runs-on: ubuntu-latest
    name: Release Status
    steps:
      # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ„å»ºçŠ¶æ€
      - name: Version Information
        run: |
          echo "ğŸš¦ Version: ${{ needs.version.outputs.version }}"
          echo "ğŸ”„ Is PR Build: ${{ needs.version.outputs.is_pr_build }}"

  merge:
    needs: [build, version]
    name: Merge Artifacts
    runs-on: ubuntu-latest
    steps:
      # ä¸‹è½½æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: release-*
          merge-multiple: true

      # åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©
      - name: List artifacts
        run: ls -R release

  publish:
    # åªæœ‰é PR æ„å»ºä¸”æ²¡æœ‰ [skip ci] æ ‡è®°çš„æäº¤æ‰æ‰§è¡Œå‘å¸ƒ
    if: |
      needs.version.outputs.is_pr_build != 'true' &&
      !contains(github.event.head_commit.message, '[skip ci]')
    needs: [merge, version]
    name: Publish Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: release-*
          merge-multiple: true

      # åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©
      - name: List artifacts
        run: ls -R release

      # å¯¹äºé release è§¦å‘çš„æ„å»ºï¼Œåˆ›å»ºä¸º draft çŠ¶æ€çš„ GitHub Release
      - name: Create Draft Release
        if: github.event_name != 'release'
        uses: softprops/action-gh-release@v1
        with:
          name: Desktop v${{ needs.version.outputs.version }}
          tag_name: v${{ needs.version.outputs.version }}
          draft: true # è®¾ç½®ä¸º draft çŠ¶æ€
          prerelease: false
          files: |
            release/latest*
            release/umi*.dmg*
            release/umi*.exe*
            release/umi*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å¯¹äº release è§¦å‘çš„æ„å»ºï¼Œå°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ°ç°æœ‰ release
      - name: Upload to existing Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            release/latest*
            release/umi*.dmg*
            release/umi*.exe*
            release/umi*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
