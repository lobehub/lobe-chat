name: Desktop Next Build

on:
  workflow_dispatch:
  push:
    branches:
      - next
  pull_request:
    paths:
      - 'apps/desktop/**'
      - 'scripts/electronWorkflow/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'bun.lockb'
      - 'src/**'
      - 'packages/**'
      - '.github/workflows/desktop-build-electron.yml'

concurrency:
  group: desktop-electron-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: 24.11.1
  BUN_VERSION: 1.2.23

jobs:
  build-next:
    name: Build desktop Next bundle
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=6144
      UPDATE_CHANNEL: nightly
      APP_URL: http://localhost:3015
      DATABASE_URL: postgresql://postgres@localhost:5432/postgres
      KEY_VAULTS_SECRET: oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE=
      NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_NIGHTLY_DESKTOP_PROJECT_ID || 'dummy-desktop-project' }}
      NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_NIGHTLY_DESKTOP_BASE_URL || 'https://analytics.example.com' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: pnpm install --node-linker=hoisted

      - name: Install desktop dependencies
        run: |
          cd apps/desktop
          bun run install-isolated

      - name: Build desktop Next.js bundle
        run: bun run desktop:build-electron
