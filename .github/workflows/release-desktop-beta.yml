name: Release Desktop Beta

on:
  release:
    types: [published] # å‘å¸ƒ release æ—¶è§¦å‘æ„å»º

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªç›¸åŒçš„ workflowï¼Œå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æ—§çš„è¿è¡Œ
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

# Add default permissions
permissions: read-all

jobs:
  test:
    name: Code quality check
    # æ·»åŠ  PR label è§¦å‘æ¡ä»¶ï¼Œåªæœ‰æ·»åŠ äº† trigger:build-desktop æ ‡ç­¾çš„ PR æ‰ä¼šè§¦å‘æ„å»º
    runs-on: ubuntu-latest # åªåœ¨ ubuntu ä¸Šè¿è¡Œä¸€æ¬¡æ£€æŸ¥
    steps:
      - name: Checkout base
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.23

      - name: Install deps
        run: bun i

      - name: Lint
        run: bun run lint

  version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œä¾›åç»­ job ä½¿ç”¨
      version: ${{ steps.set_version.outputs.version }}
      is_pr_build: ${{ steps.set_version.outputs.is_pr_build }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          package-manager-cache: false

      # ä¸»è¦é€»è¾‘ï¼šç¡®å®šæ„å»ºç‰ˆæœ¬å·
      - name: Set version
        id: set_version
        run: |
          # ä» apps/desktop/package.json è¯»å–åŸºç¡€ç‰ˆæœ¬å·
          base_version=$(node -p "require('./apps/desktop/package.json').version")

          # Release äº‹ä»¶ç›´æ¥ä½¿ç”¨ release tag ä½œä¸ºç‰ˆæœ¬å·ï¼Œå»æ‰å¯èƒ½çš„ v å‰ç¼€
          version="${{ github.event.release.tag_name }}"
          version="${version#v}"
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Release Version: ${version}"

      # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯æ€»ç»“ï¼Œæ–¹ä¾¿åœ¨ GitHub Actions ç•Œé¢æŸ¥çœ‹
      - name: Version Summary
        run: |
          echo "ğŸš¦ Release Version: ${{ steps.set_version.outputs.version }}"

  build:
    needs: [version, test]
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, macos-15-intel, windows-2025, ubuntu-latest]
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          package-manager-cache: false

      # node-linker=hoisted æ¨¡å¼å°†å¯ä»¥ç¡®ä¿ asar å‹ç¼©å¯ç”¨
      - name: Install dependencies
        run: pnpm install --node-linker=hoisted

      - name: Install deps on Desktop
        run: npm run install-isolated --prefix=./apps/desktop

      # è®¾ç½® package.json çš„ç‰ˆæœ¬å·
      - name: Set package version
        run: npm run workflow:set-desktop-version ${{ needs.version.outputs.version }} beta

      # macOS æ„å»ºå¤„ç†
      - name: Build artifact on macOS
        if: runner.os == 'macOS'
        run: npm run desktop:build
        env:
          APP_URL: http://localhost:3015
          DATABASE_URL: "postgresql://postgres@localhost:5432/postgres"
          # é»˜è®¤æ·»åŠ ä¸€ä¸ªåŠ å¯† SECRET
          KEY_VAULTS_SECRET: "oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE="
          # macOS ç­¾åå’Œå…¬è¯é…ç½®
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # allow provisionally
          CSC_FOR_PULL_REQUEST: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}

      #  Windows å¹³å°æ„å»ºå¤„ç†
      - name: Build artifact on Windows
        if: runner.os == 'Windows'
        run: npm run desktop:build
        env:
          APP_URL: http://localhost:3015
          DATABASE_URL: "postgresql://postgres@localhost:5432/postgres"
          KEY_VAULTS_SECRET: "oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE="
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}

          # å°† TEMP å’Œ TMP ç›®å½•è®¾ç½®åˆ° C ç›˜
          TEMP: C:\temp
          TMP: C:\temp

      # Linux å¹³å°æ„å»ºå¤„ç†
      - name: Build artifact on Linux
        if: runner.os == 'Linux'
        run: npm run desktop:build
        env:
          APP_URL: http://localhost:3015
          DATABASE_URL: "postgresql://postgres@localhost:5432/postgres"
          KEY_VAULTS_SECRET: "oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE="
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}

      # å¤„ç† macOS latest-mac.yml é‡å‘½å (é¿å…å¤šæ¶æ„è¦†ç›–)
      - name: Rename macOS latest-mac.yml for multi-architecture support
        if: runner.os == 'macOS'
        run: |
          cd apps/desktop/release
          if [ -f "latest-mac.yml" ]; then
            # ä½¿ç”¨ç³»ç»Ÿæ¶æ„æ£€æµ‹ï¼Œä¸ electron-builder è¾“å‡ºä¿æŒä¸€è‡´
            SYSTEM_ARCH=$(uname -m)
            if [[ "$SYSTEM_ARCH" == "arm64" ]]; then
              ARCH_SUFFIX="arm64"
            else
              ARCH_SUFFIX="x64"
            fi

            mv latest-mac.yml "latest-mac-${ARCH_SUFFIX}.yml"
            echo "âœ… Renamed latest-mac.yml to latest-mac-${ARCH_SUFFIX}.yml (detected: $SYSTEM_ARCH)"
            ls -la latest-mac-*.yml
          else
            echo "âš ï¸ latest-mac.yml not found, skipping rename"
            ls -la latest*.yml || echo "No latest*.yml files found"
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰© (å·¥ä½œæµå¤„ç†é‡å‘½åï¼Œä¸ä¾èµ– electron-builder é’©å­)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: |
            apps/desktop/release/latest*
            apps/desktop/release/*.dmg*
            apps/desktop/release/*.zip*
            apps/desktop/release/*.exe*
            apps/desktop/release/*.AppImage
            apps/desktop/release/*.deb*
            apps/desktop/release/*.snap*
            apps/desktop/release/*.rpm*
            apps/desktop/release/*.tar.gz*
          retention-days: 5

  # åˆå¹¶ macOS å¤šæ¶æ„ latest-mac.yml æ–‡ä»¶
  merge-mac-files:
    needs: [build, version]
    name: Merge macOS Release Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.23

      # ä¸‹è½½æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©
      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          path: release
          pattern: release-*
          merge-multiple: true

      # åˆ—å‡ºä¸‹è½½çš„æ„å»ºäº§ç‰©
      - name: List downloaded artifacts
        run: ls -R release

      # ä»…ä¸ºè¯¥æ­¥éª¤åœ¨è„šæœ¬ç›®å½•å®‰è£… yaml å•åŒ…ï¼Œé¿å…å®‰è£…æ•´ä¸ª monorepo ä¾èµ–
      - name: Install yaml only for merge step
        run: |
          cd scripts/electronWorkflow
          # åœ¨è„šæœ¬ç›®å½•åˆ›å»ºæœ€å° package.jsonï¼Œé˜²æ­¢ bun å‘ä¸Šå¯»æ‰¾æ ¹ package.json
          if [ ! -f package.json ]; then
            echo '{"name":"merge-mac-release","private":true}' > package.json
          fi
          bun add --no-save yaml@2.8.1

      # åˆå¹¶ macOS YAML æ–‡ä»¶ (ä½¿ç”¨ bun è¿è¡Œ JavaScript)
      - name: Merge latest-mac.yml files
        run: bun run scripts/electronWorkflow/mergeMacReleaseFiles.js

      # ä¸Šä¼ åˆå¹¶åçš„æ„å»ºäº§ç‰©
      - name: Upload artifacts with merged macOS files
        uses: actions/upload-artifact@v4
        with:
          name: merged-release
          path: release/
          retention-days: 1

  # å‘å¸ƒæ‰€æœ‰å¹³å°æ„å»ºäº§ç‰©
  publish-release:
    needs: [merge-mac-files]
    name: Publish Beta Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ä¸‹è½½åˆå¹¶åçš„æ„å»ºäº§ç‰©
      - name: Download merged artifacts
        uses: actions/download-artifact@v5
        with:
          name: merged-release
          path: release

      # åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©
      - name: List final artifacts
        run: ls -R release

      # å°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ°ç°æœ‰ release (ç°åœ¨åŒ…å«åˆå¹¶åçš„ latest-mac.yml)
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            release/latest*
            release/*.dmg*
            release/*.zip*
            release/*.exe*
            release/*.AppImage
            release/*.deb*
            release/*.snap*
            release/*.rpm*
            release/*.tar.gz*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
