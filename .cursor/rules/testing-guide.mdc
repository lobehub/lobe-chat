---
globs: *.test.ts,*.test.tsx
alwaysApply: false
---

# æµ‹è¯•æŒ‡å— - LobeChat Testing Guide

## ğŸ§ª æµ‹è¯•ç¯å¢ƒæ¦‚è§ˆ

LobeChat é¡¹ç›®ä½¿ç”¨ Vitest æµ‹è¯•åº“ï¼Œé…ç½®äº†ä¸¤ç§ä¸åŒçš„æµ‹è¯•ç¯å¢ƒï¼š

### å®¢æˆ·ç«¯æµ‹è¯•ç¯å¢ƒ (DOM Environment)

- **é…ç½®æ–‡ä»¶**: [vitest.config.ts](mdc:vitest.config.ts)
- **ç¯å¢ƒ**: Happy DOM (æµè§ˆå™¨ç¯å¢ƒæ¨¡æ‹Ÿ)
- **æ•°æ®åº“**: PGLite (æµè§ˆå™¨ç¯å¢ƒçš„ PostgreSQL)
- **ç”¨é€”**: æµ‹è¯•å‰ç«¯ç»„ä»¶ã€å®¢æˆ·ç«¯é€»è¾‘ã€React ç»„ä»¶ç­‰
- **è®¾ç½®æ–‡ä»¶**: [tests/setup.ts](mdc:tests/setup.ts)

### æœåŠ¡ç«¯æµ‹è¯•ç¯å¢ƒ (Node Environment)

- **é…ç½®æ–‡ä»¶**: [vitest.config.server.ts](mdc:vitest.config.server.ts)
- **ç¯å¢ƒ**: Node.js
- **æ•°æ®åº“**: çœŸå®çš„ PostgreSQL æ•°æ®åº“
- **å¹¶å‘é™åˆ¶**: å•çº¿ç¨‹è¿è¡Œ (`singleFork: true`)
- **ç”¨é€”**: æµ‹è¯•æ•°æ®åº“æ¨¡å‹ã€æœåŠ¡ç«¯é€»è¾‘ã€API ç«¯ç‚¹ç­‰
- **è®¾ç½®æ–‡ä»¶**: [tests/setup-db.ts](mdc:tests/setup-db.ts)

## ğŸš€ æµ‹è¯•è¿è¡Œå‘½ä»¤

### package.json è„šæœ¬è¯´æ˜

æŸ¥çœ‹ [package.json](mdc:package.json) ä¸­çš„æµ‹è¯•ç›¸å…³è„šæœ¬ï¼š

```json
{
  "test": "npm run test-app && npm run test-server",
  "test-app": "vitest run --config vitest.config.ts",
  "test-app:coverage": "vitest run --config vitest.config.ts --coverage",
  "test-server": "vitest run --config vitest.config.server.ts",
  "test-server:coverage": "vitest run --config vitest.config.server.ts --coverage"
}
```

### æ¨èçš„æµ‹è¯•è¿è¡Œæ–¹å¼

#### âš ï¸ é‡è¦æé†’

**ğŸš¨ æ€§èƒ½è­¦å‘Š**:

- **æ°¸è¿œä¸è¦ç›´æ¥è¿è¡Œæ•´ä¸ªé¡¹ç›®çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹** - é¡¹ç›®åŒ…å« 3000+ æµ‹è¯•ç”¨ä¾‹ï¼Œå®Œæ•´è¿è¡Œéœ€è¦çº¦ 10 åˆ†é’Ÿ
- **åŠ¡å¿…ä½¿ç”¨æ–‡ä»¶è¿‡æ»¤æˆ–æµ‹è¯•åç§°è¿‡æ»¤** - å§‹ç»ˆæŒ‡å®šå…·ä½“çš„æµ‹è¯•æ–‡ä»¶æˆ–æµ‹è¯•åç§°æ¨¡å¼
- **é¿å…æ— æ„ä¸­è§¦å‘å…¨é‡æµ‹è¯•** - æŸäº›çœ‹ä¼¼é’ˆå¯¹å•ä¸ªæ–‡ä»¶çš„å‘½ä»¤å®é™…ä¸Šä¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•

#### âœ… æ­£ç¡®çš„å‘½ä»¤æ ¼å¼

```bash
# è¿è¡Œæ‰€æœ‰å®¢æˆ·ç«¯æµ‹è¯•
npx vitest run --config vitest.config.ts

# è¿è¡Œæ‰€æœ‰æœåŠ¡ç«¯æµ‹è¯•
npx vitest run --config vitest.config.server.ts

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶ (æ”¯æŒæ¨¡ç³ŠåŒ¹é…)
npx vitest run --config vitest.config.ts basic
npx vitest run --config vitest.config.ts user.test.ts

# è¿è¡Œç‰¹å®šæ–‡ä»¶çš„ç‰¹å®šè¡Œå·
npx vitest run --config vitest.config.ts src/utils/helper.test.ts:25
npx vitest run --config vitest.config.ts basic/foo.test.ts:10,basic/foo.test.ts:25

# è¿‡æ»¤ç‰¹å®šæµ‹è¯•ç”¨ä¾‹åç§°
npx vitest -t "test case name" --config vitest.config.ts

# ç»„åˆä½¿ç”¨æ–‡ä»¶å’Œæµ‹è¯•åç§°è¿‡æ»¤
npx vitest run --config vitest.config.ts filename.test.ts -t "specific test"
```

#### âŒ é¿å…çš„å‘½ä»¤æ ¼å¼

```bash
# âŒ è¿™äº›å‘½ä»¤ä¼šè¿è¡Œæ‰€æœ‰ 3000+ æµ‹è¯•ç”¨ä¾‹ï¼Œè€—æ—¶çº¦ 10 åˆ†é’Ÿï¼
npm test
npm run test
pnpm test
pnpm run test

# âŒ è¿™äº›å‘½ä»¤çœ‹ä¼¼é’ˆå¯¹å•ä¸ªæ–‡ä»¶ï¼Œä½†å®é™…ä¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼, éœ€è¦ç›´æ¥è¿è¡Œ vitest å‘½ä»¤ä¸è¦ä½¿ç”¨ test npm script
npm test src/libs/model-runtime/utils/openaiCompatibleFactory/index.test.ts
pnpm test src/components/Button/index.test.tsx

# âŒ ä¸è¦ä½¿ç”¨ pnpm test xxx (è¿™ä¸æ˜¯æœ‰æ•ˆçš„ vitest å‘½ä»¤)
pnpm test some-file

# âŒ ä¸è¦ä½¿ç”¨è£¸ vitest (ä¼šè¿›å…¥ watch æ¨¡å¼)
vitest test-file.test.ts

# âŒ ä¸è¦æ··æ·†æµ‹è¯•ç¯å¢ƒ
npx vitest run --config vitest.config.server.ts client-component.test.ts
```

### å…³é”®è¿è¡Œå‚æ•°è¯´æ˜

- **`vitest run`**: è¿è¡Œä¸€æ¬¡æµ‹è¯•ç„¶åé€€å‡º (é¿å… watch æ¨¡å¼)
- **`vitest`**: é»˜è®¤è¿›å…¥ watch æ¨¡å¼ï¼ŒæŒç»­ç›‘å¬æ–‡ä»¶å˜åŒ–
- **`--config`**: æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œé€‰æ‹©æ­£ç¡®çš„æµ‹è¯•ç¯å¢ƒ
- **`-t`**: è¿‡æ»¤æµ‹è¯•ç”¨ä¾‹åç§°ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼
- **`--coverage`**: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

## ğŸ”§ æµ‹è¯•ä¿®å¤åŸåˆ™

### æ ¸å¿ƒåŸåˆ™ âš ï¸

1. **å……åˆ†é˜…è¯»æµ‹è¯•ä»£ç **: åœ¨ä¿®å¤æµ‹è¯•ä¹‹å‰ï¼Œå¿…é¡»å®Œæ•´ç†è§£æµ‹è¯•çš„æ„å›¾å’Œå®ç°
2. **æµ‹è¯•ä¼˜å…ˆä¿®å¤**: å¦‚æœæ˜¯æµ‹è¯•æœ¬èº«å†™é”™äº†ï¼Œä¿®æ”¹æµ‹è¯•è€Œä¸æ˜¯å®ç°ä»£ç 
3. **ä¸“æ³¨å•ä¸€é—®é¢˜**: åªä¿®å¤æŒ‡å®šçš„æµ‹è¯•ï¼Œä¸è¦æ·»åŠ é¢å¤–æµ‹è¯•æˆ–åŠŸèƒ½
4. **ä¸è‡ªä½œä¸»å¼ **: ä¸è¦å› ä¸ºå‘ç°å…¶ä»–é—®é¢˜å°±ç›´æ¥ä¿®æ”¹ï¼Œå…ˆæå‡ºå†è®¨è®º

### æµ‹è¯•ä¿®å¤æµç¨‹

```mermaid
flowchart TD
    subgraph "é˜¶æ®µä¸€ï¼šåˆ†æä¸å¤ç°"
        A[å¼€å§‹ï¼šæ”¶åˆ°æµ‹è¯•å¤±è´¥æŠ¥å‘Š] --> B[å®šä½å¹¶è¿è¡Œå¤±è´¥çš„æµ‹è¯•];
        B --> C{æ˜¯å¦èƒ½åœ¨æœ¬åœ°å¤ç°?};
        C -->|å¦| D[æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ/é…ç½®/ä¾èµ–];
        C -->|æ˜¯| E[åˆ†æï¼šé˜…è¯»æµ‹è¯•ä»£ç ã€é”™è¯¯æ—¥å¿—ã€Git å†å²];
    end

    subgraph "é˜¶æ®µäºŒï¼šè¯Šæ–­ä¸è°ƒè¯•"
        E --> F[å»ºç«‹å‡è®¾ï¼šé—®é¢˜å‡ºåœ¨æµ‹è¯•ã€ä»£ç è¿˜æ˜¯ç¯å¢ƒ?];
        F --> G["è°ƒè¯•ï¼šä½¿ç”¨ console.log æˆ– debugger æ·±å…¥æ£€æŸ¥"];
        G --> H{å‡è®¾æ˜¯å¦è¢«è¯å®?};
        H -->|å¦, é‡æ–°å‡è®¾| F;
    end

    subgraph "é˜¶æ®µä¸‰ï¼šä¿®å¤ä¸éªŒè¯"
        H -->|æ˜¯| I{ç¡®å®šæ ¹æœ¬åŸå› };
        I -->|æµ‹è¯•é€»è¾‘é”™è¯¯| J[ä¿®å¤æµ‹è¯•ä»£ç ];
        I -->|å®ç°ä»£ç  Bug| K[ä¿®å¤å®ç°ä»£ç ];
        I -->|ç¯å¢ƒ/é…ç½®é—®é¢˜| L[ä¿®å¤é…ç½®æˆ–ä¾èµ–];
        J --> M[éªŒè¯ä¿®å¤ï¼šé‡æ–°è¿è¡Œå¤±è´¥çš„æµ‹è¯•];
        K --> M;
        L --> M;
        M --> N{æµ‹è¯•æ˜¯å¦é€šè¿‡?};
        N -->|å¦, ä¿®å¤æ— æ•ˆ| F;
        N -->|æ˜¯| O[æ‰©å¤§éªŒè¯ï¼šè¿è¡Œå½“å‰æ–‡ä»¶å†…æ‰€æœ‰æµ‹è¯•];
        O --> P{æ˜¯å¦å…¨éƒ¨é€šè¿‡?};
        P -->|å¦, å¼•å…¥æ–°é—®é¢˜| F;
    end

    subgraph "é˜¶æ®µå››ï¼šæ€»ç»“"
        P -->|æ˜¯| Q[å®Œæˆï¼šæ’°å†™ä¿®å¤æ€»ç»“];
    end

    D --> F;
```

### ä¿®å¤å®Œæˆåçš„æ€»ç»“

æµ‹è¯•ä¿®å¤å®Œæˆåï¼Œåº”è¯¥æä¾›ç®€è¦è¯´æ˜ï¼ŒåŒ…æ‹¬ï¼š

1. **é”™è¯¯åŸå› åˆ†æ**: è¯´æ˜æµ‹è¯•å¤±è´¥çš„æ ¹æœ¬åŸå› 
   - æµ‹è¯•é€»è¾‘é”™è¯¯
   - å®ç°ä»£ç bug
   - ç¯å¢ƒé…ç½®é—®é¢˜
   - ä¾èµ–å˜æ›´å¯¼è‡´çš„é—®é¢˜

2. **ä¿®å¤æ–¹æ³•è¯´æ˜**: ç®€è¿°é‡‡ç”¨çš„ä¿®å¤æ–¹å¼
   - ä¿®æ”¹äº†å“ªäº›æ–‡ä»¶
   - é‡‡ç”¨äº†ä»€ä¹ˆè§£å†³æ–¹æ¡ˆ
   - ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§ä¿®å¤æ–¹å¼

**ç¤ºä¾‹æ ¼å¼**:

```markdown
## æµ‹è¯•ä¿®å¤æ€»ç»“

**é”™è¯¯åŸå› **: æµ‹è¯•ä¸­çš„ mock æ•°æ®æ ¼å¼ä¸å®é™… API è¿”å›æ ¼å¼ä¸åŒ¹é…ï¼Œå¯¼è‡´æ–­è¨€å¤±è´¥ã€‚

**ä¿®å¤æ–¹æ³•**: æ›´æ–°äº†æµ‹è¯•æ–‡ä»¶ä¸­çš„ mock æ•°æ®ç»“æ„ï¼Œä½¿å…¶ä¸æœ€æ–°çš„ API å“åº”æ ¼å¼ä¿æŒä¸€è‡´ã€‚å…·ä½“ä¿®æ”¹äº† `user.test.ts` ä¸­çš„ `mockUserData` å¯¹è±¡ç»“æ„ã€‚
```

## ğŸ“‚ æµ‹è¯•æ–‡ä»¶ç»„ç»‡

### æ–‡ä»¶å‘½åçº¦å®š

- **å®¢æˆ·ç«¯æµ‹è¯•**: `*.test.ts`, `*.test.tsx` (ä»»æ„ä½ç½®)
- **æœåŠ¡ç«¯æµ‹è¯•**: `src/database/models/**/*.test.ts`, `src/database/server/**/*.test.ts` (é™å®šè·¯å¾„)

### æµ‹è¯•æ–‡ä»¶ç»„ç»‡é£æ ¼

é¡¹ç›®é‡‡ç”¨ **æµ‹è¯•æ–‡ä»¶ä¸æºæ–‡ä»¶åŒç›®å½•** çš„ç»„ç»‡é£æ ¼ï¼š

- æµ‹è¯•æ–‡ä»¶æ”¾åœ¨å¯¹åº”æºæ–‡ä»¶çš„åŒä¸€ç›®å½•ä¸‹
- å‘½åæ ¼å¼ï¼š`åŸæ–‡ä»¶å.test.ts` æˆ– `åŸæ–‡ä»¶å.test.tsx`

ä¾‹å¦‚ï¼š

```
src/components/Button/
â”œâ”€â”€ index.tsx           # æºæ–‡ä»¶
â””â”€â”€ index.test.tsx      # æµ‹è¯•æ–‡ä»¶
```

## ğŸ› ï¸ æµ‹è¯•è°ƒè¯•æŠ€å·§

### è¿è¡Œå¤±è´¥æµ‹è¯•çš„æ­¥éª¤

1. **ç¡®å®šæµ‹è¯•ç±»å‹**: æŸ¥çœ‹æ–‡ä»¶è·¯å¾„ç¡®å®šä½¿ç”¨å“ªä¸ªé…ç½®
2. **è¿è¡Œå•ä¸ªæµ‹è¯•**: ä½¿ç”¨ `-t` å‚æ•°éš”ç¦»é—®é¢˜
3. **æ£€æŸ¥é”™è¯¯æ—¥å¿—**: ä»”ç»†é˜…è¯»é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
4. **æŸ¥çœ‹æœ€è¿‘ä¿®æ”¹è®°å½•**: æ£€æŸ¥ç›¸å…³æ–‡ä»¶çš„æœ€è¿‘å˜æ›´æƒ…å†µ
5. **æ·»åŠ è°ƒè¯•æ—¥å¿—**: åœ¨æµ‹è¯•ä¸­æ·»åŠ  `console.log` äº†è§£æ‰§è¡Œæµç¨‹

### TypeScript ç±»å‹å¤„ç† ğŸ“

åœ¨æµ‹è¯•ä¸­ï¼Œä¸ºäº†æé«˜ç¼–å†™æ•ˆç‡å’Œå¯è¯»æ€§ï¼Œå¯ä»¥é€‚å½“æ”¾å®½ TypeScript ç±»å‹æ£€æµ‹ï¼š

#### âœ… æ¨èçš„ç±»å‹æ”¾å®½ç­–ç•¥

```typescript
// âœ… ä½¿ç”¨éç©ºæ–­è¨€è®¿é—®æµ‹è¯•ä¸­ç¡®å®šå­˜åœ¨çš„å±æ€§
const result = await someFunction();
expect(result!.data).toBeDefined();
expect(result!.status).toBe('success');

// âœ… ä½¿ç”¨ any ç±»å‹ç®€åŒ–å¤æ‚çš„ Mock è®¾ç½®
const mockStream = new ReadableStream() as any;
mockStream.toReadableStream = () => mockStream;
```

#### ğŸ¯ é€‚ç”¨åœºæ™¯

- **Mock å¯¹è±¡**: å¯¹äºæµ‹è¯•ç”¨çš„ Mock æ•°æ®ï¼Œä½¿ç”¨ `as any` é¿å…å¤æ‚çš„ç±»å‹å®šä¹‰
- **ç¬¬ä¸‰æ–¹åº“**: å¤„ç†å¤æ‚çš„ç¬¬ä¸‰æ–¹åº“ç±»å‹æ—¶ï¼Œé€‚å½“ä½¿ç”¨ `any` æé«˜æ•ˆç‡
- **æµ‹è¯•æ–­è¨€**: åœ¨ç¡®å®šå¯¹è±¡å­˜åœ¨çš„æµ‹è¯•åœºæ™¯ä¸­ï¼Œä½¿ç”¨ `!` éç©ºæ–­è¨€
- **ä¸´æ—¶è°ƒè¯•**: å¿«é€Ÿç¼–å†™æµ‹è¯•æ—¶ï¼Œå…ˆç”¨ `any` ä¿è¯åŠŸèƒ½ï¼Œåç»­å¯é€‰æ‹©æ€§åœ°ä¼˜åŒ–ç±»å‹

#### âš ï¸ æ³¨æ„äº‹é¡¹

- **é€‚åº¦ä½¿ç”¨**: ä¸è¦è¿‡åº¦ä¾èµ– `any`ï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ç±»å‹ä»åº”ä¿æŒä¸¥æ ¼
- **æ–‡æ¡£è¯´æ˜**: å¯¹äºä½¿ç”¨ `any` çš„å¤æ‚åœºæ™¯ï¼Œæ·»åŠ æ³¨é‡Šè¯´æ˜åŸå› 
- **æµ‹è¯•è¦†ç›–**: ç¡®ä¿å³ä½¿ä½¿ç”¨äº† `any`ï¼Œæµ‹è¯•ä»èƒ½æœ‰æ•ˆéªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

### Electron IPC æ¥å£æµ‹è¯•ç­–ç•¥ ğŸ–¥ï¸

å¯¹äºæ¶‰åŠ Electron IPC æ¥å£çš„æµ‹è¯•ï¼Œç”±äºæä¾›çœŸå®çš„ Electron ç¯å¢ƒæ¯”è¾ƒå¤æ‚ï¼Œé‡‡ç”¨ **Mock è¿”å›å€¼** çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ã€‚

#### åŸºæœ¬ Mock è®¾ç½®

```typescript
import { vi } from 'vitest';

import { electronIpcClient } from '@/server/modules/ElectronIPCClient';

// Mock Electron IPC å®¢æˆ·ç«¯
vi.mock('@/server/modules/ElectronIPCClient', () => ({
  electronIpcClient: {
    getFilePathById: vi.fn(),
    deleteFiles: vi.fn(),
    // æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»– IPC æ–¹æ³•
  },
}));
```

#### åœ¨æµ‹è¯•ä¸­è®¾ç½® Mock è¡Œä¸º

```typescript
beforeEach(() => {
  // é‡ç½®æ‰€æœ‰ Mock
  vi.resetAllMocks();

  // è®¾ç½®é»˜è®¤çš„ Mock è¿”å›å€¼
  vi.mocked(electronIpcClient.getFilePathById).mockResolvedValue('/path/to/file.txt');
  vi.mocked(electronIpcClient.deleteFiles).mockResolvedValue({
    success: true,
  });
});
```

#### æµ‹è¯•ä¸åŒåœºæ™¯çš„ç¤ºä¾‹

```typescript
it('åº”è¯¥å¤„ç†æ–‡ä»¶åˆ é™¤æˆåŠŸçš„æƒ…å†µ', async () => {
  // è®¾ç½®æˆåŠŸåœºæ™¯çš„ Mock
  vi.mocked(electronIpcClient.deleteFiles).mockResolvedValue({
    success: true,
  });

  const result = await service.deleteFiles(['desktop://file1.txt']);

  expect(electronIpcClient.deleteFiles).toHaveBeenCalledWith(['desktop://file1.txt']);
  expect(result.success).toBe(true);
});

it('åº”è¯¥å¤„ç†æ–‡ä»¶åˆ é™¤å¤±è´¥çš„æƒ…å†µ', async () => {
  // è®¾ç½®å¤±è´¥åœºæ™¯çš„ Mock
  vi.mocked(electronIpcClient.deleteFiles).mockRejectedValue(new Error('åˆ é™¤å¤±è´¥'));

  const result = await service.deleteFiles(['desktop://file1.txt']);

  expect(result.success).toBe(false);
  expect(result.errors).toBeDefined();
});
```

#### Mock ç­–ç•¥çš„ä¼˜åŠ¿

1. **ç¯å¢ƒç®€åŒ–**: é¿å…äº†å¤æ‚çš„ Electron ç¯å¢ƒæ­å»º
2. **æµ‹è¯•å¯æ§**: å¯ä»¥ç²¾ç¡®æ§åˆ¶ IPC è°ƒç”¨çš„è¿”å›å€¼å’Œè¡Œä¸º
3. **åœºæ™¯è¦†ç›–**: å®¹æ˜“æµ‹è¯•å„ç§æˆåŠŸ/å¤±è´¥åœºæ™¯
4. **æ‰§è¡Œé€Ÿåº¦**: Mock è°ƒç”¨æ¯”çœŸå® IPC è°ƒç”¨æ›´å¿«

#### æ³¨æ„äº‹é¡¹

- **Mock å‡†ç¡®æ€§**: ç¡®ä¿ Mock çš„è¡Œä¸ºä¸çœŸå® IPC æ¥å£è¡Œä¸ºä¸€è‡´
- **ç±»å‹å®‰å…¨**: ä½¿ç”¨ `vi.mocked()` ç¡®ä¿ç±»å‹å®‰å…¨
- **Mock é‡ç½®**: åœ¨ `beforeEach` ä¸­é‡ç½® Mock çŠ¶æ€ï¼Œé¿å…æµ‹è¯•é—´å¹²æ‰°
- **è°ƒç”¨éªŒè¯**: ä¸ä»…è¦éªŒè¯è¿”å›å€¼ï¼Œè¿˜è¦éªŒè¯ IPC æ–¹æ³•æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨

### æ£€æŸ¥æœ€è¿‘ä¿®æ”¹è®°å½• ğŸ”

ä¸ºäº†æ›´å¥½åœ°åˆ¤æ–­æµ‹è¯•å¤±è´¥çš„æ ¹æœ¬åŸå› ï¼Œéœ€è¦**ç³»ç»Ÿæ€§åœ°æ£€æŸ¥ç›¸å…³æ–‡ä»¶çš„ä¿®æ”¹å†å²**ã€‚è¿™æ˜¯é—®é¢˜å®šä½çš„å…³é”®æ­¥éª¤ã€‚

#### ç¬¬ä¸€æ­¥ï¼šç¡®å®šéœ€è¦æ£€æŸ¥çš„æ–‡ä»¶èŒƒå›´

1. **æµ‹è¯•æ–‡ä»¶æœ¬èº«**: `path/to/component.test.ts`
2. **å¯¹åº”çš„å®ç°æ–‡ä»¶**: `path/to/component.ts` æˆ– `path/to/component/index.ts`
3. **ç›¸å…³ä¾èµ–æ–‡ä»¶**: æµ‹è¯•æˆ–å®ç°ä¸­å¯¼å…¥çš„å…¶ä»–æ¨¡å—

#### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥å½“å‰å·¥ä½œç›®å½•çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹çŠ¶æ€
git status

# é‡ç‚¹å…³æ³¨æµ‹è¯•æ–‡ä»¶å’Œå®ç°æ–‡ä»¶æ˜¯å¦æœ‰æœªæäº¤çš„ä¿®æ”¹
git status | grep -E "(test|spec)"
```

#### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥æœªæäº¤çš„ä¿®æ”¹å†…å®¹

```bash
# æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶çš„æœªæäº¤ä¿®æ”¹ (å·¥ä½œåŒº vs æš‚å­˜åŒº)
git diff path/to/component.test.ts | cat

# æŸ¥çœ‹å¯¹åº”å®ç°æ–‡ä»¶çš„æœªæäº¤ä¿®æ”¹
git diff path/to/component.ts | cat

# æŸ¥çœ‹å·²æš‚å­˜ä½†æœªæäº¤çš„ä¿®æ”¹
git diff --cached path/to/component.test.ts | cat
git diff --cached path/to/component.ts | cat
```

#### ç¬¬å››æ­¥ï¼šæ£€æŸ¥æäº¤å†å²å’Œæ—¶é—´ç›¸å…³æ€§

**é¦–å…ˆæŸ¥çœ‹æäº¤æ—¶é—´ï¼Œåˆ¤æ–­ä¿®æ”¹çš„æ—¶æ•ˆæ€§**ï¼š

```bash
# æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶çš„æœ€è¿‘æäº¤å†å²ï¼ŒåŒ…å«æäº¤æ—¶é—´
git log --pretty=format:"%h %ad %s" --date=relative -5 path/to/component.test.ts | cat

# æŸ¥çœ‹å®ç°æ–‡ä»¶çš„æœ€è¿‘æäº¤å†å²ï¼ŒåŒ…å«æäº¤æ—¶é—´
git log --pretty=format:"%h %ad %s" --date=relative -5 path/to/component.ts | cat

# æŸ¥çœ‹è¯¦ç»†çš„æäº¤æ—¶é—´ï¼ˆISOæ ¼å¼ï¼Œä¾¿äºç²¾ç¡®åˆ¤æ–­ï¼‰
git log --pretty=format:"%h %ad %an %s" --date=iso -3 path/to/component.ts | cat
git log --pretty=format:"%h %ad %an %s" --date=iso -3 path/to/component.test.ts | cat
```

**åˆ¤æ–­æäº¤çš„å‚è€ƒä»·å€¼**ï¼š

1. **æœ€è¿‘æäº¤ï¼ˆ24å°æ—¶å†…ï¼‰**: ğŸ”´ **é«˜åº¦ç›¸å…³** - å¾ˆå¯èƒ½æ˜¯å¯¼è‡´æµ‹è¯•å¤±è´¥çš„ç›´æ¥åŸå› 
2. **è¿‘æœŸæäº¤ï¼ˆ1-7å¤©å†…ï¼‰**: ğŸŸ¡ **ä¸­ç­‰ç›¸å…³** - å¯èƒ½ç›¸å…³ï¼Œéœ€è¦ä»”ç»†åˆ†æä¿®æ”¹å†…å®¹
3. **è¾ƒæ—©æäº¤ï¼ˆè¶…è¿‡1å‘¨ï¼‰**: âšª **ä½ç›¸å…³æ€§** - é™¤éæ˜¯é‡å¤§é‡æ„ï¼Œå¦åˆ™ä¸å¤ªå¯èƒ½æ˜¯ç›´æ¥åŸå› 

#### ç¬¬äº”æ­¥ï¼šåŸºäºæ—¶é—´ç›¸å…³æ€§æŸ¥çœ‹å…·ä½“ä¿®æ”¹å†…å®¹

**æ ¹æ®æäº¤æ—¶é—´çš„è¿œè¿‘ï¼Œä¼˜å…ˆæŸ¥çœ‹æœ€è¿‘çš„ä¿®æ”¹**ï¼š

```bash
# å¦‚æœæœ‰24å°æ—¶å†…çš„æäº¤ï¼Œé‡ç‚¹æŸ¥çœ‹è¿™äº›ä¿®æ”¹
git show HEAD -- path/to/component.test.ts | cat
git show HEAD -- path/to/component.ts | cat

# æŸ¥çœ‹æ¬¡æ–°çš„æäº¤ï¼ˆå¦‚æœæœ€æ–°æäº¤æ—¶é—´è¾ƒè¿œï¼‰
git show HEAD~1 -- path/to/component.ts | cat
git show path/to/component.ts < recent-commit-hash > -- | cat

# å¯¹æ¯”æœ€è¿‘ä¸¤æ¬¡æäº¤çš„å·®å¼‚
git diff HEAD~1 HEAD -- path/to/component.ts | cat
```

#### ç¬¬å…­æ­¥ï¼šåˆ†æä¿®æ”¹ä¸æµ‹è¯•å¤±è´¥çš„å…³ç³»

åŸºäºä¿®æ”¹è®°å½•å’Œæ—¶é—´ç›¸å…³æ€§åˆ¤æ–­ï¼š

1. **æœ€è¿‘ä¿®æ”¹äº†å®ç°ä»£ç **:

   ```bash
   # é‡ç‚¹æ£€æŸ¥å®ç°é€»è¾‘çš„å˜åŒ–
   git diff HEAD~1 path/to/component.ts | cat
   ```

   - å¾ˆå¯èƒ½æ˜¯å®ç°ä»£ç çš„å˜æ›´å¯¼è‡´æµ‹è¯•å¤±è´¥
   - æ£€æŸ¥å®ç°é€»è¾‘æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æµ‹è¯•æ˜¯å¦éœ€è¦ç›¸åº”æ›´æ–°

2. **æœ€è¿‘ä¿®æ”¹äº†æµ‹è¯•ä»£ç **:

   ```bash
   # é‡ç‚¹æ£€æŸ¥æµ‹è¯•é€»è¾‘çš„å˜åŒ–
   git diff HEAD~1 path/to/component.test.ts | cat
   ```

   - å¯èƒ½æ˜¯æµ‹è¯•æœ¬èº«å†™é”™äº†
   - æ£€æŸ¥æµ‹è¯•é€»è¾‘å’Œæ–­è¨€æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æµ‹è¯•æ˜¯å¦ç¬¦åˆå®ç°çš„é¢„æœŸè¡Œä¸º

3. **ä¸¤è€…éƒ½æœ‰æœ€è¿‘ä¿®æ”¹**:

   ```bash
   # å¯¹æ¯”ä¸¤ä¸ªæ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
   git log --pretty=format:"%ad %f" --date=iso -1 path/to/component.ts | cat
   git log --pretty=format:"%ad %f" --date=iso -1 path/to/component.test.ts | cat
   ```

   - éœ€è¦ç»¼åˆåˆ†æä¸¤è€…çš„ä¿®æ”¹
   - ç¡®å®šå“ªä¸ªä¿®æ”¹æ›´å¯èƒ½å¯¼è‡´é—®é¢˜
   - ä¼˜å…ˆæ£€æŸ¥æ—¶é—´æ›´è¿‘çš„ä¿®æ”¹

4. **éƒ½æ²¡æœ‰æœ€è¿‘ä¿®æ”¹**:
   - å¯èƒ½æ˜¯ä¾èµ–å˜æ›´æˆ–ç¯å¢ƒé—®é¢˜
   - æ£€æŸ¥ `package.json`ã€é…ç½®æ–‡ä»¶ç­‰çš„ä¿®æ”¹
   - æŸ¥çœ‹æ˜¯å¦æœ‰å…¨å±€æ€§çš„ä»£ç é‡æ„

#### ä¿®æ”¹è®°å½•æ£€æŸ¥ç¤ºä¾‹

```bash
# å®Œæ•´çš„æ£€æŸ¥æµç¨‹ç¤ºä¾‹
echo "=== æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹çŠ¶æ€ ==="
git status | grep component

echo "=== æ£€æŸ¥æœªæäº¤ä¿®æ”¹ ==="
git diff src/components/Button/index.test.tsx | cat
git diff src/components/Button/index.tsx | cat

echo "=== æ£€æŸ¥æäº¤å†å²å’Œæ—¶é—´ ==="
git log --pretty=format:"%h %ad %s" --date=relative -3 src/components/Button/index.test.tsx | cat
git log --pretty=format:"%h %ad %s" --date=relative -3 src/components/Button/index.tsx | cat

echo "=== æ ¹æ®æ—¶é—´ä¼˜å…ˆçº§æŸ¥çœ‹ä¿®æ”¹å†…å®¹ ==="
# å¦‚æœæœ‰24å°æ—¶å†…çš„æäº¤ï¼Œé‡ç‚¹æŸ¥çœ‹
git show HEAD -- src/components/Button/index.tsx | cat
```

## ğŸ—ƒï¸ æ•°æ®åº“ Model æµ‹è¯•æŒ‡å—

### æµ‹è¯•ç¯å¢ƒé€‰æ‹© ğŸ’¡

æ•°æ®åº“ Model å±‚é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶æ•°æ®åº“ç±»å‹ï¼Œåœ¨ä¸¤ç§æµ‹è¯•ç¯å¢ƒä¸‹æœ‰ä¸åŒçš„æ•°æ®åº“åç«¯ï¼šå®¢æˆ·ç«¯ç¯å¢ƒ (PGLite) å’Œ æœåŠ¡ç«¯ç¯å¢ƒ (PostgreSQL)

### âš ï¸ åŒç¯å¢ƒéªŒè¯è¦æ±‚

**å¯¹äºæ‰€æœ‰ Model æµ‹è¯•ï¼Œå¿…é¡»åœ¨ä¸¤ä¸ªç¯å¢ƒä¸‹éƒ½éªŒè¯é€šè¿‡**ï¼š

#### å®Œæ•´éªŒè¯æµç¨‹

```bash
# 1. å…ˆåœ¨å®¢æˆ·ç«¯ç¯å¢ƒæµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯ï¼‰
npx vitest run --config vitest.config.ts src/database/models/__tests__/myModel.test.ts

# 2. å†åœ¨æœåŠ¡ç«¯ç¯å¢ƒæµ‹è¯•ï¼ˆå…¼å®¹æ€§éªŒè¯ï¼‰
npx vitest run --config vitest.config.server.ts src/database/models/__tests__/myModel.test.ts
```

### åˆ›å»ºæ–° Model æµ‹è¯•çš„æœ€ä½³å®è·µ ğŸ“‹

#### 1. å‚è€ƒç°æœ‰å®ç°å’Œæµ‹è¯•æ¨¡æ¿

åˆ›å»ºæ–° Model æµ‹è¯•å‰ï¼Œ**å¿…é¡»å…ˆå‚è€ƒç°æœ‰çš„å®ç°æ¨¡å¼**ï¼š

- **Model å®ç°å‚è€ƒ**:
- **æµ‹è¯•æ¨¡æ¿å‚è€ƒ**:
- **å¤æ‚ç¤ºä¾‹å‚è€ƒ**:

#### 2. ç”¨æˆ·æƒé™æ£€æŸ¥ - å®‰å…¨ç¬¬ä¸€ ğŸ”’

è¿™æ˜¯**æœ€å…³é”®çš„å®‰å…¨è¦æ±‚**ã€‚æ‰€æœ‰æ¶‰åŠç”¨æˆ·æ•°æ®çš„æ“ä½œéƒ½å¿…é¡»åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥ï¼š

**âŒ é”™è¯¯ç¤ºä¾‹ - å­˜åœ¨å®‰å…¨æ¼æ´**:

```typescript
// å±é™©ï¼šç¼ºå°‘ç”¨æˆ·æƒé™æ£€æŸ¥ï¼Œä»»ä½•ç”¨æˆ·éƒ½èƒ½æ“ä½œä»»ä½•æ•°æ®
update = async (id: string, data: Partial<MyModel>) => {
  return this.db
    .update(myTable)
    .set(data)
    .where(eq(myTable.id, id)) // âŒ åªæ£€æŸ¥ IDï¼Œæ²¡æœ‰æ£€æŸ¥ userId
    .returning();
};
```

**âœ… æ­£ç¡®ç¤ºä¾‹ - å®‰å…¨çš„å®ç°**:

```typescript
// å®‰å…¨ï¼šå¿…é¡»åŒæ—¶åŒ¹é… ID å’Œ userId
update = async (id: string, data: Partial<MyModel>) => {
  return this.db
    .update(myTable)
    .set(data)
    .where(
      and(
        eq(myTable.id, id),
        eq(myTable.userId, this.userId), // âœ… ç”¨æˆ·æƒé™æ£€æŸ¥
      ),
    )
    .returning();
};
```

**å¿…é¡»è¿›è¡Œç”¨æˆ·æƒé™æ£€æŸ¥çš„æ–¹æ³•**ï¼š

- `update()` - æ›´æ–°æ“ä½œ
- `delete()` - åˆ é™¤æ“ä½œ
- `findById()` - æŸ¥æ‰¾ç‰¹å®šè®°å½•
- ä»»ä½•æ¶‰åŠç‰¹å®šè®°å½•çš„æŸ¥è¯¢æˆ–ä¿®æ”¹æ“ä½œ

#### 3. æµ‹è¯•æ–‡ä»¶ç»“æ„å’Œå¿…æµ‹åœºæ™¯

**åŸºæœ¬æµ‹è¯•ç»“æ„**:

```typescript
// @vitest-environment node
describe('MyModel', () => {
  describe('create', () => {
    it('should create a new record');
    it('should handle edge cases');
  });

  describe('queryAll', () => {
    it('should return records for current user only');
    it('should handle empty results');
  });

  describe('update', () => {
    it('should update own records');
    it('should NOT update other users records'); // ğŸ”’ å®‰å…¨æµ‹è¯•
  });

  describe('delete', () => {
    it('should delete own records');
    it('should NOT delete other users records'); // ğŸ”’ å®‰å…¨æµ‹è¯•
  });

  describe('user isolation', () => {
    it('should enforce user data isolation'); // ğŸ”’ æ ¸å¿ƒå®‰å…¨æµ‹è¯•
  });
});
```

**å¿…é¡»æµ‹è¯•çš„å®‰å…¨åœºæ™¯** ğŸ”’:

```typescript
it('should not update records of other users', async () => {
  // åˆ›å»ºå…¶ä»–ç”¨æˆ·çš„è®°å½•
  const [otherUserRecord] = await serverDB
    .insert(myTable)
    .values({ userId: 'other-user', data: 'original' })
    .returning();

  // å°è¯•æ›´æ–°å…¶ä»–ç”¨æˆ·çš„è®°å½•
  const result = await myModel.update(otherUserRecord.id, { data: 'hacked' });

  // åº”è¯¥è¿”å› undefined æˆ–ç©ºæ•°ç»„ï¼ˆå› ä¸ºæƒé™æ£€æŸ¥å¤±è´¥ï¼‰
  expect(result).toBeUndefined();

  // éªŒè¯åŸå§‹æ•°æ®æœªè¢«ä¿®æ”¹
  const unchanged = await serverDB.query.myTable.findFirst({
    where: eq(myTable.id, otherUserRecord.id),
  });
  expect(unchanged?.data).toBe('original'); // æ•°æ®åº”è¯¥ä¿æŒä¸å˜
});
```

#### 4. Mock å¤–éƒ¨ä¾èµ–æœåŠ¡

å¦‚æœ Model ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼ˆå¦‚ FileServiceï¼‰ï¼Œéœ€è¦æ­£ç¡® Mockï¼š

**è®¾ç½® Mock**:

```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨è®¾ç½® Mock
const mockGetFullFileUrl = vi.fn();
vi.mock('@/server/services/file', () => ({
  FileService: vi.fn().mockImplementation(() => ({
    getFullFileUrl: mockGetFullFileUrl,
  })),
}));

// åœ¨ beforeEach ä¸­é‡ç½®å’Œé…ç½® Mock
beforeEach(async () => {
  vi.clearAllMocks();
  mockGetFullFileUrl.mockImplementation((url: string) => `https://example.com/${url}`);
});
```

**éªŒè¯ Mock è°ƒç”¨**:

```typescript
it('should process URLs through FileService', async () => {
  // ... æµ‹è¯•é€»è¾‘

  // éªŒè¯ Mock è¢«æ­£ç¡®è°ƒç”¨
  expect(mockGetFullFileUrl).toHaveBeenCalledWith('expected-url');
  expect(mockGetFullFileUrl).toHaveBeenCalledTimes(1);
});
```

#### 5. æ•°æ®åº“çŠ¶æ€ç®¡ç†

**æ­£ç¡®çš„æ•°æ®æ¸…ç†æ¨¡å¼**:

```typescript
const userId = 'test-user';
const otherUserId = 'other-user';

beforeEach(async () => {
  // æ¸…ç†ç”¨æˆ·è¡¨ï¼ˆçº§è”åˆ é™¤ç›¸å…³æ•°æ®ï¼‰
  await serverDB.delete(users);

  // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
  await serverDB.insert(users).values([{ id: userId }, { id: otherUserId }]);
});

afterEach(async () => {
  // æ¸…ç†æµ‹è¯•æ•°æ®
  await serverDB.delete(users);
});
```

#### 6. æµ‹è¯•æ•°æ®ç±»å‹å’Œå¤–é”®çº¦æŸå¤„ç† âš ï¸

**å¿…é¡»ä½¿ç”¨ Schema å¯¼å‡ºçš„ç±»å‹**:

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ schema å¯¼å‡ºçš„ç±»å‹
import { NewGeneration, NewGenerationBatch } from '../../schemas';

const testBatch: NewGenerationBatch = {
  userId,
  generationTopicId: 'test-topic-id',
  provider: 'test-provider',
  model: 'test-model',
  prompt: 'Test prompt for image generation',
  width: 1024,
  height: 1024,
  config: {
    /* ... */
  },
};

const testGeneration: NewGeneration = {
  id: 'test-gen-id',
  generationBatchId: 'test-batch-id',
  asyncTaskId: null, // å¤„ç†å¤–é”®çº¦æŸ
  fileId: null, // å¤„ç†å¤–é”®çº¦æŸ
  seed: 12345,
  userId,
};
```

```typescript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç±»å‹å£°æ˜æˆ–ä½¿ç”¨é”™è¯¯ç±»å‹
const testBatch = {
  // ç¼ºå°‘ç±»å‹å£°æ˜
  generationTopicId: 'test-topic-id',
  // ...
};

const testGeneration = {
  // ç¼ºå°‘ç±»å‹å£°æ˜
  asyncTaskId: 'invalid-uuid', // å¤–é”®çº¦æŸé”™è¯¯
  fileId: 'non-existent-file', // å¤–é”®çº¦æŸé”™è¯¯
  // ...
};
```

**å¤–é”®çº¦æŸå¤„ç†ç­–ç•¥**:

1. **ä½¿ç”¨ null å€¼**: å¯¹äºå¯é€‰çš„å¤–é”®å­—æ®µï¼Œä½¿ç”¨ null é¿å…çº¦æŸé”™è¯¯
2. **åˆ›å»ºå…³è”è®°å½•**: å¦‚æœéœ€è¦æµ‹è¯•å…³è”å…³ç³»ï¼Œå…ˆåˆ›å»ºè¢«å¼•ç”¨çš„è®°å½•
3. **ç†è§£çº¦æŸå…³ç³»**: äº†è§£å“ªäº›å­—æ®µæœ‰å¤–é”®çº¦æŸï¼Œé¿å…å¼•ç”¨ä¸å­˜åœ¨çš„è®°å½•

```typescript
// å¤–é”®çº¦æŸå¤„ç†ç¤ºä¾‹
beforeEach(async () => {
  // æ¸…ç†æ•°æ®åº“
  await serverDB.delete(users);

  // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
  await serverDB.insert(users).values([{ id: userId }]);

  // å¦‚æœéœ€è¦æµ‹è¯•æ–‡ä»¶å…³è”ï¼Œåˆ›å»ºæ–‡ä»¶è®°å½•
  if (needsFileAssociation) {
    await serverDB.insert(files).values({
      id: 'test-file-id',
      userId,
      name: 'test.jpg',
      url: 'test-url',
      size: 1024,
      fileType: 'image/jpeg',
    });
  }
});
```

**æ’åºæµ‹è¯•çš„å¯é¢„æµ‹æ€§**:

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ˜ç¡®çš„æ—¶é—´æˆ³ç¡®ä¿æ’åºç»“æœå¯é¢„æµ‹
it('should find batches by topic id in correct order', async () => {
  const oldDate = new Date('2024-01-01T10:00:00Z');
  const newDate = new Date('2024-01-02T10:00:00Z');

  const batch1 = { ...testBatch, prompt: 'First batch', userId, createdAt: oldDate };
  const batch2 = { ...testBatch, prompt: 'Second batch', userId, createdAt: newDate };

  await serverDB.insert(generationBatches).values([batch1, batch2]);

  const results = await generationBatchModel.findByTopicId(testTopic.id);

  expect(results[0].prompt).toBe('Second batch'); // æœ€æ–°ä¼˜å…ˆ (desc order)
  expect(results[1].prompt).toBe('First batch');
});
```

```typescript
// âŒ é”™è¯¯ï¼šä¾èµ–æ•°æ®åº“çš„é»˜è®¤æ—¶é—´æˆ³ï¼Œç»“æœä¸å¯é¢„æµ‹
it('should find batches by topic id', async () => {
  const batch1 = { ...testBatch, prompt: 'First batch', userId };
  const batch2 = { ...testBatch, prompt: 'Second batch', userId };

  await serverDB.insert(generationBatches).values([batch1, batch2]);

  // æ’å…¥é¡ºåºå’Œæ•°æ®åº“æ—¶é—´æˆ³å¯èƒ½ä¸ä¸€è‡´ï¼Œå¯¼è‡´æµ‹è¯•ä¸ç¨³å®š
  const results = await generationBatchModel.findByTopicId(testTopic.id);
  expect(results[0].prompt).toBe('Second batch'); // å¯èƒ½å¤±è´¥
});
```

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ ğŸ’¡

#### é—®é¢˜ 1ï¼šæƒé™æ£€æŸ¥ç¼ºå¤±å¯¼è‡´å®‰å…¨æ¼æ´

**ç°è±¡**: æµ‹è¯•å¤±è´¥ï¼Œç”¨æˆ·èƒ½ä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æ•°æ® **è§£å†³**: åœ¨ Model çš„ `update` å’Œ `delete` æ–¹æ³•ä¸­æ·»åŠ  `and(eq(table.id, id), eq(table.userId, this.userId))`

#### é—®é¢˜ 2ï¼šMock æœªç”Ÿæ•ˆæˆ–éªŒè¯å¤±è´¥

**ç°è±¡**: `undefined is not a spy` é”™è¯¯ **è§£å†³**: æ£€æŸ¥ Mock è®¾ç½®ä½ç½®å’Œæ–¹å¼ï¼Œç¡®ä¿åœ¨æµ‹è¯•æ–‡ä»¶é¡¶éƒ¨è®¾ç½®ï¼Œåœ¨ `beforeEach` ä¸­é‡ç½®

#### é—®é¢˜ 3ï¼šæµ‹è¯•æ•°æ®æ±¡æŸ“

**ç°è±¡**: æµ‹è¯•é—´ç›¸äº’å½±å“ï¼Œç»“æœä¸ç¨³å®š **è§£å†³**: åœ¨ `beforeEach` å’Œ `afterEach` ä¸­æ­£ç¡®æ¸…ç†æ•°æ®åº“çŠ¶æ€

#### é—®é¢˜ 4ï¼šå¤–éƒ¨ä¾èµ–å¯¼è‡´æµ‹è¯•å¤±è´¥

**ç°è±¡**: å› ä¸ºçœŸå®çš„å¤–éƒ¨æœåŠ¡è°ƒç”¨å¯¼è‡´æµ‹è¯•ä¸ç¨³å®š **è§£å†³**: Mock æ‰€æœ‰å¤–éƒ¨ä¾èµ–ï¼Œä½¿æµ‹è¯•æ›´å¯æ§å’Œå¿«é€Ÿ

#### é—®é¢˜ 5ï¼šå¤–é”®çº¦æŸè¿åå¯¼è‡´æµ‹è¯•å¤±è´¥

**ç°è±¡**: `insert or update on table "xxx" violates foreign key constraint` **è§£å†³**:

- å°†å¯é€‰å¤–é”®å­—æ®µè®¾ä¸º `null` è€Œä¸æ˜¯æ— æ•ˆçš„å­—ç¬¦ä¸²å€¼
- æˆ–è€…å…ˆåˆ›å»ºè¢«å¼•ç”¨çš„è®°å½•ï¼Œå†åˆ›å»ºå½“å‰è®°å½•

```typescript
// âŒ é”™è¯¯ï¼šæ— æ•ˆçš„å¤–é”®å€¼
const testData = {
    asyncTaskId: 'invalid-uuid',  // è¡¨ä¸­ä¸å­˜åœ¨æ­¤è®°å½•
    fileId: 'non-existent-file',  // è¡¨ä¸­ä¸å­˜åœ¨æ­¤è®°å½•
};

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ null å€¼
const testData = {
    asyncTaskId: null,  // é¿å…å¤–é”®çº¦æŸ
    fileId: null,       // é¿å…å¤–é”®çº¦æŸ
};

// âœ… æˆ–è€…ï¼šå…ˆåˆ›å»ºè¢«å¼•ç”¨çš„è®°å½•
beforeEach(async () => {
    const [asyncTask] = await serverDB.insert(asyncTasks).values({
        id: 'valid-task-id',
        status: 'pending',
        type: 'generation',
    }).returning();

    const testData = {
        asyncTaskId: asyncTask.id,  // ä½¿ç”¨æœ‰æ•ˆçš„å¤–é”®å€¼
    };
});
```

#### é—®é¢˜ 6ï¼šæ’åºæµ‹è¯•ç»“æœä¸ä¸€è‡´

**ç°è±¡**: ç›¸åŒçš„æµ‹è¯•æœ‰æ—¶é€šè¿‡ï¼Œæœ‰æ—¶å¤±è´¥ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠæ’åºçš„æµ‹è¯• **è§£å†³**: ä½¿ç”¨æ˜ç¡®çš„æ—¶é—´æˆ³ï¼Œä¸è¦ä¾èµ–æ•°æ®åº“çš„é»˜è®¤æ—¶é—´æˆ³

```typescript
// âŒ é”™è¯¯ï¼šä¾èµ–æ’å…¥é¡ºåºå’Œé»˜è®¤æ—¶é—´æˆ³
await serverDB.insert(table).values([data1, data2]); // æ—¶é—´æˆ³ä¸å¯é¢„æµ‹

// âœ… æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šæ—¶é—´æˆ³
const oldDate = new Date('2024-01-01T10:00:00Z');
const newDate = new Date('2024-01-02T10:00:00Z');
await serverDB.insert(table).values([
  { ...data1, createdAt: oldDate },
  { ...data2, createdAt: newDate },
]);
```

#### é—®é¢˜ 7ï¼šMock éªŒè¯å¤±è´¥æˆ–è°ƒç”¨æ¬¡æ•°ä¸åŒ¹é…

**ç°è±¡**: `expect(mockFunction).toHaveBeenCalledWith(...)` å¤±è´¥ **è§£å†³**:

- æ£€æŸ¥ Mock å‡½æ•°çš„å®é™…è°ƒç”¨å‚æ•°å’ŒæœŸæœ›å‚æ•°æ˜¯å¦å®Œå…¨åŒ¹é…
- ç¡®è®¤ Mock åœ¨æ­£ç¡®çš„æ—¶æœºè¢«é‡ç½®å’Œé…ç½®
- ä½¿ç”¨ `toHaveBeenCalledTimes()` éªŒè¯è°ƒç”¨æ¬¡æ•°

```typescript
// åœ¨ beforeEach ä¸­æ­£ç¡®é…ç½® Mock
beforeEach(() => {
  vi.clearAllMocks(); // é‡ç½®æ‰€æœ‰ Mock

  mockGetFullFileUrl.mockImplementation((url: string) => `https://example.com/${url}`);
  mockTransformGeneration.mockResolvedValue({
    id: 'test-id',
    // ... å…¶ä»–å­—æ®µ
  });
});

// æµ‹è¯•ä¸­éªŒè¯ Mock è°ƒç”¨
it('should call FileService with correct parameters', async () => {
  await model.someMethod();

  // éªŒè¯è°ƒç”¨å‚æ•°
  expect(mockGetFullFileUrl).toHaveBeenCalledWith('expected-url');
  // éªŒè¯è°ƒç”¨æ¬¡æ•°
  expect(mockGetFullFileUrl).toHaveBeenCalledTimes(1);
});
```

### Model æµ‹è¯•æ£€æŸ¥æ¸…å• âœ…

åˆ›å»º Model æµ‹è¯•æ—¶ï¼Œè¯·ç¡®ä¿ä»¥ä¸‹å„é¡¹éƒ½å·²å®Œæˆï¼š

#### ğŸ”§ åŸºç¡€é…ç½®

- [ ] **åŒç¯å¢ƒéªŒè¯** - åœ¨å®¢æˆ·ç«¯ç¯å¢ƒ (vitest.config.ts) å’ŒæœåŠ¡ç«¯ç¯å¢ƒ (vitest.config.server.ts) ä¸‹éƒ½æµ‹è¯•é€šè¿‡
- [ ] å‚è€ƒäº† `_template.ts` å’Œç°æœ‰ Model çš„å®ç°æ¨¡å¼
- [ ] **ä½¿ç”¨æ­£ç¡®çš„ Schema ç±»å‹** - æµ‹è¯•æ•°æ®ä½¿ç”¨ `NewXxx` ç±»å‹å£°æ˜ï¼Œå¦‚ `NewGenerationBatch`ã€`NewGeneration`

#### ğŸ”’ å®‰å…¨æµ‹è¯•

- [ ] **æ‰€æœ‰æ¶‰åŠç”¨æˆ·æ•°æ®çš„æ“ä½œéƒ½åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥**
- [ ] åŒ…å«äº†ç”¨æˆ·æƒé™éš”ç¦»çš„å®‰å…¨æµ‹è¯•
- [ ] æµ‹è¯•äº†ç”¨æˆ·æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·æ•°æ®çš„åœºæ™¯

#### ğŸ—ƒï¸ æ•°æ®å¤„ç†

- [ ] **æ­£ç¡®å¤„ç†å¤–é”®çº¦æŸ** - ä½¿ç”¨ `null` å€¼æˆ–å…ˆåˆ›å»ºè¢«å¼•ç”¨è®°å½•
- [ ] **æ’åºæµ‹è¯•ä½¿ç”¨æ˜ç¡®æ—¶é—´æˆ³** - ä¸ä¾èµ–æ•°æ®åº“é»˜è®¤æ—¶é—´ï¼Œç¡®ä¿ç»“æœå¯é¢„æµ‹
- [ ] åœ¨ `beforeEach` å’Œ `afterEach` ä¸­æ­£ç¡®ç®¡ç†æ•°æ®åº“çŠ¶æ€
- [ ] æ‰€æœ‰æµ‹è¯•éƒ½èƒ½ç‹¬ç«‹è¿è¡Œä¸”äº’ä¸å¹²æ‰°

#### ğŸ­ Mock å’Œå¤–éƒ¨ä¾èµ–

- [ ] æ­£ç¡® Mock äº†å¤–éƒ¨ä¾èµ–æœåŠ¡ (å¦‚ FileServiceã€GenerationModel)
- [ ] åœ¨ `beforeEach` ä¸­é‡ç½®å’Œé…ç½® Mock
- [ ] éªŒè¯äº† Mock æœåŠ¡çš„è°ƒç”¨å‚æ•°å’Œæ¬¡æ•°
- [ ] æµ‹è¯•äº†å¤–éƒ¨æœåŠ¡é”™è¯¯åœºæ™¯çš„å¤„ç†

#### ğŸ“‹ æµ‹è¯•è¦†ç›–

- [ ] æµ‹è¯•è¦†ç›–äº†æ‰€æœ‰ä¸»è¦æ–¹æ³• (create, query, update, delete)
- [ ] æµ‹è¯•äº†è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯åœºæ™¯
- [ ] åŒ…å«äº†ç©ºç»“æœå¤„ç†çš„æµ‹è¯•
- [ ] **ç¡®è®¤ä¸¤ä¸ªç¯å¢ƒä¸‹çš„æµ‹è¯•ç»“æœä¸€è‡´**

#### ğŸš¨ å¸¸è§é—®é¢˜æ£€æŸ¥

- [ ] æ²¡æœ‰å¤–é”®çº¦æŸè¿åé”™è¯¯
- [ ] æ’åºæµ‹è¯•ç»“æœç¨³å®šå¯é¢„æµ‹
- [ ] Mock éªŒè¯æ— å¤±è´¥
- [ ] æ— æµ‹è¯•æ•°æ®æ±¡æŸ“é—®é¢˜

### å®‰å…¨è­¦å‘Š âš ï¸

**æ•°æ®åº“ Model å±‚æ˜¯å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿**ã€‚å¦‚æœ Model å±‚ç¼ºå°‘ç”¨æˆ·æƒé™æ£€æŸ¥ï¼š

1. **ä»»ä½•ç”¨æˆ·éƒ½èƒ½è®¿é—®å’Œä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æ•°æ®**
2. **å³ä½¿ä¸Šå±‚æœ‰æƒé™æ£€æŸ¥ï¼Œä¹Ÿå¯èƒ½è¢«ç»•è¿‡**
3. **å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ•°æ®æ³„éœ²å’Œå®‰å…¨äº‹æ•…**

å› æ­¤ï¼Œ**æ¯ä¸ªæ¶‰åŠç”¨æˆ·æ•°æ®çš„ Model æ–¹æ³•éƒ½å¿…é¡»åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥ï¼Œä¸”å¿…é¡»æœ‰å¯¹åº”çš„å®‰å…¨æµ‹è¯•æ¥éªŒè¯è¿™äº›æ£€æŸ¥çš„æœ‰æ•ˆæ€§**ã€‚

## ğŸ¯ æ€»ç»“

ä¿®å¤æµ‹è¯•æ—¶ï¼Œè®°ä½ä»¥ä¸‹å…³é”®ç‚¹ï¼š

- **ä½¿ç”¨æ­£ç¡®çš„å‘½ä»¤**: `npx vitest run --config [config-file]`
- **ç†è§£æµ‹è¯•æ„å›¾**: å…ˆè¯»æ‡‚æµ‹è¯•å†ä¿®å¤
- **æŸ¥çœ‹æœ€è¿‘ä¿®æ”¹**: æ£€æŸ¥ç›¸å…³æ–‡ä»¶çš„ git ä¿®æ”¹è®°å½•ï¼Œåˆ¤æ–­é—®é¢˜æ ¹æº
- **é€‰æ‹©æ­£ç¡®ç¯å¢ƒ**: å®¢æˆ·ç«¯æµ‹è¯•ç”¨ `vitest.config.ts`ï¼ŒæœåŠ¡ç«¯ç”¨ `vitest.config.server.ts`
- **ä¸“æ³¨å•ä¸€é—®é¢˜**: åªä¿®å¤å½“å‰çš„æµ‹è¯•å¤±è´¥
- **éªŒè¯ä¿®å¤ç»“æœ**: ç¡®ä¿ä¿®å¤åæµ‹è¯•é€šè¿‡ä¸”æ— å‰¯ä½œç”¨
- **æä¾›ä¿®å¤æ€»ç»“**: è¯´æ˜é”™è¯¯åŸå› å’Œä¿®å¤æ–¹æ³•
- **Model æµ‹è¯•å®‰å…¨ç¬¬ä¸€**: å¿…é¡»åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥å’Œå¯¹åº”çš„å®‰å…¨æµ‹è¯•
- **Model åŒç¯å¢ƒéªŒè¯**: å¿…é¡»åœ¨ PGLite å’Œ PostgreSQL ä¸¤ä¸ªç¯å¢ƒä¸‹éƒ½éªŒè¯é€šè¿‡

# æµ‹è¯•æŒ‡å— - LobeChat Testing Guide

## ğŸ§ª æµ‹è¯•ç¯å¢ƒæ¦‚è§ˆ

LobeChat é¡¹ç›®ä½¿ç”¨ Vitest æµ‹è¯•åº“ï¼Œé…ç½®äº†ä¸¤ç§ä¸åŒçš„æµ‹è¯•ç¯å¢ƒï¼š

### å®¢æˆ·ç«¯æµ‹è¯•ç¯å¢ƒ (DOM Environment)

- **é…ç½®æ–‡ä»¶**: [vitest.config.ts](mdc:vitest.config.ts)
- **ç¯å¢ƒ**: Happy DOM (æµè§ˆå™¨ç¯å¢ƒæ¨¡æ‹Ÿ)
- **æ•°æ®åº“**: PGLite (æµè§ˆå™¨ç¯å¢ƒçš„ PostgreSQL)
- **ç”¨é€”**: æµ‹è¯•å‰ç«¯ç»„ä»¶ã€å®¢æˆ·ç«¯é€»è¾‘ã€React ç»„ä»¶ç­‰
- **è®¾ç½®æ–‡ä»¶**: [tests/setup.ts](mdc:tests/setup.ts)

### æœåŠ¡ç«¯æµ‹è¯•ç¯å¢ƒ (Node Environment)

- **é…ç½®æ–‡ä»¶**: [vitest.config.server.ts](mdc:vitest.config.server.ts)
- **ç¯å¢ƒ**: Node.js
- **æ•°æ®åº“**: çœŸå®çš„ PostgreSQL æ•°æ®åº“
- **å¹¶å‘é™åˆ¶**: å•çº¿ç¨‹è¿è¡Œ (`singleFork: true`)
- **ç”¨é€”**: æµ‹è¯•æ•°æ®åº“æ¨¡å‹ã€æœåŠ¡ç«¯é€»è¾‘ã€API ç«¯ç‚¹ç­‰
- **è®¾ç½®æ–‡ä»¶**: [tests/setup-db.ts](mdc:tests/setup-db.ts)

## ğŸš€ æµ‹è¯•è¿è¡Œå‘½ä»¤

### package.json è„šæœ¬è¯´æ˜

æŸ¥çœ‹ [package.json](mdc:package.json) ä¸­çš„æµ‹è¯•ç›¸å…³è„šæœ¬ï¼š

```json
{
  "test": "npm run test-app && npm run test-server",
  "test-app": "vitest run --config vitest.config.ts",
  "test-app:coverage": "vitest run --config vitest.config.ts --coverage",
  "test-server": "vitest run --config vitest.config.server.ts",
  "test-server:coverage": "vitest run --config vitest.config.server.ts --coverage"
}
```

### æ¨èçš„æµ‹è¯•è¿è¡Œæ–¹å¼

#### âš ï¸ é‡è¦æé†’

**ğŸš¨ æ€§èƒ½è­¦å‘Š**:

- **æ°¸è¿œä¸è¦ç›´æ¥è¿è¡Œæ•´ä¸ªé¡¹ç›®çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹** - é¡¹ç›®åŒ…å« 3000+ æµ‹è¯•ç”¨ä¾‹ï¼Œå®Œæ•´è¿è¡Œéœ€è¦çº¦ 10 åˆ†é’Ÿ
- **åŠ¡å¿…ä½¿ç”¨æ–‡ä»¶è¿‡æ»¤æˆ–æµ‹è¯•åç§°è¿‡æ»¤** - å§‹ç»ˆæŒ‡å®šå…·ä½“çš„æµ‹è¯•æ–‡ä»¶æˆ–æµ‹è¯•åç§°æ¨¡å¼
- **é¿å…æ— æ„ä¸­è§¦å‘å…¨é‡æµ‹è¯•** - æŸäº›çœ‹ä¼¼é’ˆå¯¹å•ä¸ªæ–‡ä»¶çš„å‘½ä»¤å®é™…ä¸Šä¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•

#### âœ… æ­£ç¡®çš„å‘½ä»¤æ ¼å¼

```bash
# è¿è¡Œæ‰€æœ‰å®¢æˆ·ç«¯æµ‹è¯•
npx vitest run --config vitest.config.ts

# è¿è¡Œæ‰€æœ‰æœåŠ¡ç«¯æµ‹è¯•
npx vitest run --config vitest.config.server.ts

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶ (æ”¯æŒæ¨¡ç³ŠåŒ¹é…)
npx vitest run --config vitest.config.ts basic
npx vitest run --config vitest.config.ts user.test.ts

# è¿è¡Œç‰¹å®šæ–‡ä»¶çš„ç‰¹å®šè¡Œå·
npx vitest run --config vitest.config.ts src/utils/helper.test.ts:25
npx vitest run --config vitest.config.ts basic/foo.test.ts:10,basic/foo.test.ts:25

# è¿‡æ»¤ç‰¹å®šæµ‹è¯•ç”¨ä¾‹åç§°
npx vitest -t "test case name" --config vitest.config.ts

# ç»„åˆä½¿ç”¨æ–‡ä»¶å’Œæµ‹è¯•åç§°è¿‡æ»¤
npx vitest run --config vitest.config.ts filename.test.ts -t "specific test"
```

#### âŒ é¿å…çš„å‘½ä»¤æ ¼å¼

```bash
# âŒ è¿™äº›å‘½ä»¤ä¼šè¿è¡Œæ‰€æœ‰ 3000+ æµ‹è¯•ç”¨ä¾‹ï¼Œè€—æ—¶çº¦ 10 åˆ†é’Ÿï¼
npm test
npm run test
pnpm test
pnpm run test

# âŒ è¿™äº›å‘½ä»¤çœ‹ä¼¼é’ˆå¯¹å•ä¸ªæ–‡ä»¶ï¼Œä½†å®é™…ä¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼, éœ€è¦ç›´æ¥è¿è¡Œ vitest å‘½ä»¤ä¸è¦ä½¿ç”¨ test npm script
npm test src/libs/model-runtime/utils/openaiCompatibleFactory/index.test.ts
pnpm test src/components/Button/index.test.tsx

# âŒ ä¸è¦ä½¿ç”¨ pnpm test xxx (è¿™ä¸æ˜¯æœ‰æ•ˆçš„ vitest å‘½ä»¤)
pnpm test some-file

# âŒ ä¸è¦ä½¿ç”¨è£¸ vitest (ä¼šè¿›å…¥ watch æ¨¡å¼)
vitest test-file.test.ts

# âŒ ä¸è¦æ··æ·†æµ‹è¯•ç¯å¢ƒ
npx vitest run --config vitest.config.server.ts client-component.test.ts
```

### å…³é”®è¿è¡Œå‚æ•°è¯´æ˜

- **`vitest run`**: è¿è¡Œä¸€æ¬¡æµ‹è¯•ç„¶åé€€å‡º (é¿å… watch æ¨¡å¼)
- **`vitest`**: é»˜è®¤è¿›å…¥ watch æ¨¡å¼ï¼ŒæŒç»­ç›‘å¬æ–‡ä»¶å˜åŒ–
- **`--config`**: æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œé€‰æ‹©æ­£ç¡®çš„æµ‹è¯•ç¯å¢ƒ
- **`-t`**: è¿‡æ»¤æµ‹è¯•ç”¨ä¾‹åç§°ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼
- **`--coverage`**: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

## ğŸ”§ æµ‹è¯•ä¿®å¤åŸåˆ™

### æ ¸å¿ƒåŸåˆ™ âš ï¸

1. **å……åˆ†é˜…è¯»æµ‹è¯•ä»£ç **: åœ¨ä¿®å¤æµ‹è¯•ä¹‹å‰ï¼Œå¿…é¡»å®Œæ•´ç†è§£æµ‹è¯•çš„æ„å›¾å’Œå®ç°
2. **æµ‹è¯•ä¼˜å…ˆä¿®å¤**: å¦‚æœæ˜¯æµ‹è¯•æœ¬èº«å†™é”™äº†ï¼Œä¿®æ”¹æµ‹è¯•è€Œä¸æ˜¯å®ç°ä»£ç 
3. **ä¸“æ³¨å•ä¸€é—®é¢˜**: åªä¿®å¤æŒ‡å®šçš„æµ‹è¯•ï¼Œä¸è¦æ·»åŠ é¢å¤–æµ‹è¯•æˆ–åŠŸèƒ½
4. **ä¸è‡ªä½œä¸»å¼ **: ä¸è¦å› ä¸ºå‘ç°å…¶ä»–é—®é¢˜å°±ç›´æ¥ä¿®æ”¹ï¼Œå…ˆæå‡ºå†è®¨è®º

### æµ‹è¯•ä¿®å¤æµç¨‹

```mermaid
flowchart TD
    subgraph "é˜¶æ®µä¸€ï¼šåˆ†æä¸å¤ç°"
        A[å¼€å§‹ï¼šæ”¶åˆ°æµ‹è¯•å¤±è´¥æŠ¥å‘Š] --> B[å®šä½å¹¶è¿è¡Œå¤±è´¥çš„æµ‹è¯•];
        B --> C{æ˜¯å¦èƒ½åœ¨æœ¬åœ°å¤ç°?};
        C -->|å¦| D[æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ/é…ç½®/ä¾èµ–];
        C -->|æ˜¯| E[åˆ†æï¼šé˜…è¯»æµ‹è¯•ä»£ç ã€é”™è¯¯æ—¥å¿—ã€Git å†å²];
    end

    subgraph "é˜¶æ®µäºŒï¼šè¯Šæ–­ä¸è°ƒè¯•"
        E --> F[å»ºç«‹å‡è®¾ï¼šé—®é¢˜å‡ºåœ¨æµ‹è¯•ã€ä»£ç è¿˜æ˜¯ç¯å¢ƒ?];
        F --> G["è°ƒè¯•ï¼šä½¿ç”¨ console.log æˆ– debugger æ·±å…¥æ£€æŸ¥"];
        G --> H{å‡è®¾æ˜¯å¦è¢«è¯å®?};
        H -->|å¦, é‡æ–°å‡è®¾| F;
    end

    subgraph "é˜¶æ®µä¸‰ï¼šä¿®å¤ä¸éªŒè¯"
        H -->|æ˜¯| I{ç¡®å®šæ ¹æœ¬åŸå› };
        I -->|æµ‹è¯•é€»è¾‘é”™è¯¯| J[ä¿®å¤æµ‹è¯•ä»£ç ];
        I -->|å®ç°ä»£ç  Bug| K[ä¿®å¤å®ç°ä»£ç ];
        I -->|ç¯å¢ƒ/é…ç½®é—®é¢˜| L[ä¿®å¤é…ç½®æˆ–ä¾èµ–];
        J --> M[éªŒè¯ä¿®å¤ï¼šé‡æ–°è¿è¡Œå¤±è´¥çš„æµ‹è¯•];
        K --> M;
        L --> M;
        M --> N{æµ‹è¯•æ˜¯å¦é€šè¿‡?};
        N -->|å¦, ä¿®å¤æ— æ•ˆ| F;
        N -->|æ˜¯| O[æ‰©å¤§éªŒè¯ï¼šè¿è¡Œå½“å‰æ–‡ä»¶å†…æ‰€æœ‰æµ‹è¯•];
        O --> P{æ˜¯å¦å…¨éƒ¨é€šè¿‡?};
        P -->|å¦, å¼•å…¥æ–°é—®é¢˜| F;
    end

    subgraph "é˜¶æ®µå››ï¼šæ€»ç»“"
        P -->|æ˜¯| Q[å®Œæˆï¼šæ’°å†™ä¿®å¤æ€»ç»“];
    end

    D --> F;
```

### ä¿®å¤å®Œæˆåçš„æ€»ç»“

æµ‹è¯•ä¿®å¤å®Œæˆåï¼Œåº”è¯¥æä¾›ç®€è¦è¯´æ˜ï¼ŒåŒ…æ‹¬ï¼š

1. **é”™è¯¯åŸå› åˆ†æ**: è¯´æ˜æµ‹è¯•å¤±è´¥çš„æ ¹æœ¬åŸå› 
   - æµ‹è¯•é€»è¾‘é”™è¯¯
   - å®ç°ä»£ç bug
   - ç¯å¢ƒé…ç½®é—®é¢˜
   - ä¾èµ–å˜æ›´å¯¼è‡´çš„é—®é¢˜

2. **ä¿®å¤æ–¹æ³•è¯´æ˜**: ç®€è¿°é‡‡ç”¨çš„ä¿®å¤æ–¹å¼
   - ä¿®æ”¹äº†å“ªäº›æ–‡ä»¶
   - é‡‡ç”¨äº†ä»€ä¹ˆè§£å†³æ–¹æ¡ˆ
   - ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§ä¿®å¤æ–¹å¼

**ç¤ºä¾‹æ ¼å¼**:

```markdown
## æµ‹è¯•ä¿®å¤æ€»ç»“

**é”™è¯¯åŸå› **: æµ‹è¯•ä¸­çš„ mock æ•°æ®æ ¼å¼ä¸å®é™… API è¿”å›æ ¼å¼ä¸åŒ¹é…ï¼Œå¯¼è‡´æ–­è¨€å¤±è´¥ã€‚

**ä¿®å¤æ–¹æ³•**: æ›´æ–°äº†æµ‹è¯•æ–‡ä»¶ä¸­çš„ mock æ•°æ®ç»“æ„ï¼Œä½¿å…¶ä¸æœ€æ–°çš„ API å“åº”æ ¼å¼ä¿æŒä¸€è‡´ã€‚å…·ä½“ä¿®æ”¹äº† `user.test.ts` ä¸­çš„ `mockUserData` å¯¹è±¡ç»“æ„ã€‚
```

## ğŸ“‚ æµ‹è¯•æ–‡ä»¶ç»„ç»‡

### æ–‡ä»¶å‘½åçº¦å®š

- **å®¢æˆ·ç«¯æµ‹è¯•**: `*.test.ts`, `*.test.tsx` (ä»»æ„ä½ç½®)
- **æœåŠ¡ç«¯æµ‹è¯•**: `src/database/models/**/*.test.ts`, `src/database/server/**/*.test.ts` (é™å®šè·¯å¾„)

### æµ‹è¯•æ–‡ä»¶ç»„ç»‡é£æ ¼

é¡¹ç›®é‡‡ç”¨ **æµ‹è¯•æ–‡ä»¶ä¸æºæ–‡ä»¶åŒç›®å½•** çš„ç»„ç»‡é£æ ¼ï¼š

- æµ‹è¯•æ–‡ä»¶æ”¾åœ¨å¯¹åº”æºæ–‡ä»¶çš„åŒä¸€ç›®å½•ä¸‹
- å‘½åæ ¼å¼ï¼š`åŸæ–‡ä»¶å.test.ts` æˆ– `åŸæ–‡ä»¶å.test.tsx`

ä¾‹å¦‚ï¼š

```
src/components/Button/
â”œâ”€â”€ index.tsx           # æºæ–‡ä»¶
â””â”€â”€ index.test.tsx      # æµ‹è¯•æ–‡ä»¶
```

## ğŸ› ï¸ æµ‹è¯•è°ƒè¯•æŠ€å·§

### è¿è¡Œå¤±è´¥æµ‹è¯•çš„æ­¥éª¤

1. **ç¡®å®šæµ‹è¯•ç±»å‹**: æŸ¥çœ‹æ–‡ä»¶è·¯å¾„ç¡®å®šä½¿ç”¨å“ªä¸ªé…ç½®
2. **è¿è¡Œå•ä¸ªæµ‹è¯•**: ä½¿ç”¨ `-t` å‚æ•°éš”ç¦»é—®é¢˜
3. **æ£€æŸ¥é”™è¯¯æ—¥å¿—**: ä»”ç»†é˜…è¯»é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
4. **æŸ¥çœ‹æœ€è¿‘ä¿®æ”¹è®°å½•**: æ£€æŸ¥ç›¸å…³æ–‡ä»¶çš„æœ€è¿‘å˜æ›´æƒ…å†µ
5. **æ·»åŠ è°ƒè¯•æ—¥å¿—**: åœ¨æµ‹è¯•ä¸­æ·»åŠ  `console.log` äº†è§£æ‰§è¡Œæµç¨‹

### TypeScript ç±»å‹å¤„ç† ğŸ“

åœ¨æµ‹è¯•ä¸­ï¼Œä¸ºäº†æé«˜ç¼–å†™æ•ˆç‡å’Œå¯è¯»æ€§ï¼Œå¯ä»¥é€‚å½“æ”¾å®½ TypeScript ç±»å‹æ£€æµ‹ï¼š

#### âœ… æ¨èçš„ç±»å‹æ”¾å®½ç­–ç•¥

```typescript
// âœ… ä½¿ç”¨éç©ºæ–­è¨€è®¿é—®æµ‹è¯•ä¸­ç¡®å®šå­˜åœ¨çš„å±æ€§
const result = await someFunction();
expect(result!.data).toBeDefined();
expect(result!.status).toBe('success');

// âœ… ä½¿ç”¨ any ç±»å‹ç®€åŒ–å¤æ‚çš„ Mock è®¾ç½®
const mockStream = new ReadableStream() as any;
mockStream.toReadableStream = () => mockStream;
```

#### ğŸ¯ é€‚ç”¨åœºæ™¯

- **Mock å¯¹è±¡**: å¯¹äºæµ‹è¯•ç”¨çš„ Mock æ•°æ®ï¼Œä½¿ç”¨ `as any` é¿å…å¤æ‚çš„ç±»å‹å®šä¹‰
- **ç¬¬ä¸‰æ–¹åº“**: å¤„ç†å¤æ‚çš„ç¬¬ä¸‰æ–¹åº“ç±»å‹æ—¶ï¼Œé€‚å½“ä½¿ç”¨ `any` æé«˜æ•ˆç‡
- **æµ‹è¯•æ–­è¨€**: åœ¨ç¡®å®šå¯¹è±¡å­˜åœ¨çš„æµ‹è¯•åœºæ™¯ä¸­ï¼Œä½¿ç”¨ `!` éç©ºæ–­è¨€
- **ä¸´æ—¶è°ƒè¯•**: å¿«é€Ÿç¼–å†™æµ‹è¯•æ—¶ï¼Œå…ˆç”¨ `any` ä¿è¯åŠŸèƒ½ï¼Œåç»­å¯é€‰æ‹©æ€§åœ°ä¼˜åŒ–ç±»å‹

#### âš ï¸ æ³¨æ„äº‹é¡¹

- **é€‚åº¦ä½¿ç”¨**: ä¸è¦è¿‡åº¦ä¾èµ– `any`ï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ç±»å‹ä»åº”ä¿æŒä¸¥æ ¼
- **æ–‡æ¡£è¯´æ˜**: å¯¹äºä½¿ç”¨ `any` çš„å¤æ‚åœºæ™¯ï¼Œæ·»åŠ æ³¨é‡Šè¯´æ˜åŸå› 
- **æµ‹è¯•è¦†ç›–**: ç¡®ä¿å³ä½¿ä½¿ç”¨äº† `any`ï¼Œæµ‹è¯•ä»èƒ½æœ‰æ•ˆéªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

### Electron IPC æ¥å£æµ‹è¯•ç­–ç•¥ ğŸ–¥ï¸

å¯¹äºæ¶‰åŠ Electron IPC æ¥å£çš„æµ‹è¯•ï¼Œç”±äºæä¾›çœŸå®çš„ Electron ç¯å¢ƒæ¯”è¾ƒå¤æ‚ï¼Œé‡‡ç”¨ **Mock è¿”å›å€¼** çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ã€‚

#### åŸºæœ¬ Mock è®¾ç½®

```typescript
import { vi } from 'vitest';

import { electronIpcClient } from '@/server/modules/ElectronIPCClient';

// Mock Electron IPC å®¢æˆ·ç«¯
vi.mock('@/server/modules/ElectronIPCClient', () => ({
  electronIpcClient: {
    getFilePathById: vi.fn(),
    deleteFiles: vi.fn(),
    // æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»– IPC æ–¹æ³•
  },
}));
```

#### åœ¨æµ‹è¯•ä¸­è®¾ç½® Mock è¡Œä¸º

```typescript
beforeEach(() => {
  // é‡ç½®æ‰€æœ‰ Mock
  vi.resetAllMocks();

  // è®¾ç½®é»˜è®¤çš„ Mock è¿”å›å€¼
  vi.mocked(electronIpcClient.getFilePathById).mockResolvedValue('/path/to/file.txt');
  vi.mocked(electronIpcClient.deleteFiles).mockResolvedValue({
    success: true,
  });
});
```

#### æµ‹è¯•ä¸åŒåœºæ™¯çš„ç¤ºä¾‹

```typescript
it('åº”è¯¥å¤„ç†æ–‡ä»¶åˆ é™¤æˆåŠŸçš„æƒ…å†µ', async () => {
  // è®¾ç½®æˆåŠŸåœºæ™¯çš„ Mock
  vi.mocked(electronIpcClient.deleteFiles).mockResolvedValue({
    success: true,
  });

  const result = await service.deleteFiles(['desktop://file1.txt']);

  expect(electronIpcClient.deleteFiles).toHaveBeenCalledWith(['desktop://file1.txt']);
  expect(result.success).toBe(true);
});

it('åº”è¯¥å¤„ç†æ–‡ä»¶åˆ é™¤å¤±è´¥çš„æƒ…å†µ', async () => {
  // è®¾ç½®å¤±è´¥åœºæ™¯çš„ Mock
  vi.mocked(electronIpcClient.deleteFiles).mockRejectedValue(new Error('åˆ é™¤å¤±è´¥'));

  const result = await service.deleteFiles(['desktop://file1.txt']);

  expect(result.success).toBe(false);
  expect(result.errors).toBeDefined();
});
```

#### Mock ç­–ç•¥çš„ä¼˜åŠ¿

1. **ç¯å¢ƒç®€åŒ–**: é¿å…äº†å¤æ‚çš„ Electron ç¯å¢ƒæ­å»º
2. **æµ‹è¯•å¯æ§**: å¯ä»¥ç²¾ç¡®æ§åˆ¶ IPC è°ƒç”¨çš„è¿”å›å€¼å’Œè¡Œä¸º
3. **åœºæ™¯è¦†ç›–**: å®¹æ˜“æµ‹è¯•å„ç§æˆåŠŸ/å¤±è´¥åœºæ™¯
4. **æ‰§è¡Œé€Ÿåº¦**: Mock è°ƒç”¨æ¯”çœŸå® IPC è°ƒç”¨æ›´å¿«

#### æ³¨æ„äº‹é¡¹

- **Mock å‡†ç¡®æ€§**: ç¡®ä¿ Mock çš„è¡Œä¸ºä¸çœŸå® IPC æ¥å£è¡Œä¸ºä¸€è‡´
- **ç±»å‹å®‰å…¨**: ä½¿ç”¨ `vi.mocked()` ç¡®ä¿ç±»å‹å®‰å…¨
- **Mock é‡ç½®**: åœ¨ `beforeEach` ä¸­é‡ç½® Mock çŠ¶æ€ï¼Œé¿å…æµ‹è¯•é—´å¹²æ‰°
- **è°ƒç”¨éªŒè¯**: ä¸ä»…è¦éªŒè¯è¿”å›å€¼ï¼Œè¿˜è¦éªŒè¯ IPC æ–¹æ³•æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨

### æ£€æŸ¥æœ€è¿‘ä¿®æ”¹è®°å½• ğŸ”

ä¸ºäº†æ›´å¥½åœ°åˆ¤æ–­æµ‹è¯•å¤±è´¥çš„æ ¹æœ¬åŸå› ï¼Œéœ€è¦**ç³»ç»Ÿæ€§åœ°æ£€æŸ¥ç›¸å…³æ–‡ä»¶çš„ä¿®æ”¹å†å²**ã€‚è¿™æ˜¯é—®é¢˜å®šä½çš„å…³é”®æ­¥éª¤ã€‚

#### ç¬¬ä¸€æ­¥ï¼šç¡®å®šéœ€è¦æ£€æŸ¥çš„æ–‡ä»¶èŒƒå›´

1. **æµ‹è¯•æ–‡ä»¶æœ¬èº«**: `path/to/component.test.ts`
2. **å¯¹åº”çš„å®ç°æ–‡ä»¶**: `path/to/component.ts` æˆ– `path/to/component/index.ts`
3. **ç›¸å…³ä¾èµ–æ–‡ä»¶**: æµ‹è¯•æˆ–å®ç°ä¸­å¯¼å…¥çš„å…¶ä»–æ¨¡å—

#### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥å½“å‰å·¥ä½œç›®å½•çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹çŠ¶æ€
git status

# é‡ç‚¹å…³æ³¨æµ‹è¯•æ–‡ä»¶å’Œå®ç°æ–‡ä»¶æ˜¯å¦æœ‰æœªæäº¤çš„ä¿®æ”¹
git status | grep -E "(test|spec)"
```

#### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥æœªæäº¤çš„ä¿®æ”¹å†…å®¹

```bash
# æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶çš„æœªæäº¤ä¿®æ”¹ (å·¥ä½œåŒº vs æš‚å­˜åŒº)
git diff path/to/component.test.ts | cat

# æŸ¥çœ‹å¯¹åº”å®ç°æ–‡ä»¶çš„æœªæäº¤ä¿®æ”¹
git diff path/to/component.ts | cat

# æŸ¥çœ‹å·²æš‚å­˜ä½†æœªæäº¤çš„ä¿®æ”¹
git diff --cached path/to/component.test.ts | cat
git diff --cached path/to/component.ts | cat
```

#### ç¬¬å››æ­¥ï¼šæ£€æŸ¥æäº¤å†å²å’Œæ—¶é—´ç›¸å…³æ€§

**é¦–å…ˆæŸ¥çœ‹æäº¤æ—¶é—´ï¼Œåˆ¤æ–­ä¿®æ”¹çš„æ—¶æ•ˆæ€§**ï¼š

```bash
# æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶çš„æœ€è¿‘æäº¤å†å²ï¼ŒåŒ…å«æäº¤æ—¶é—´
git log --pretty=format:"%h %ad %s" --date=relative -5 path/to/component.test.ts | cat

# æŸ¥çœ‹å®ç°æ–‡ä»¶çš„æœ€è¿‘æäº¤å†å²ï¼ŒåŒ…å«æäº¤æ—¶é—´
git log --pretty=format:"%h %ad %s" --date=relative -5 path/to/component.ts | cat

# æŸ¥çœ‹è¯¦ç»†çš„æäº¤æ—¶é—´ï¼ˆISOæ ¼å¼ï¼Œä¾¿äºç²¾ç¡®åˆ¤æ–­ï¼‰
git log --pretty=format:"%h %ad %an %s" --date=iso -3 path/to/component.ts | cat
git log --pretty=format:"%h %ad %an %s" --date=iso -3 path/to/component.test.ts | cat
```

**åˆ¤æ–­æäº¤çš„å‚è€ƒä»·å€¼**ï¼š

1. **æœ€è¿‘æäº¤ï¼ˆ24å°æ—¶å†…ï¼‰**: ğŸ”´ **é«˜åº¦ç›¸å…³** - å¾ˆå¯èƒ½æ˜¯å¯¼è‡´æµ‹è¯•å¤±è´¥çš„ç›´æ¥åŸå› 
2. **è¿‘æœŸæäº¤ï¼ˆ1-7å¤©å†…ï¼‰**: ğŸŸ¡ **ä¸­ç­‰ç›¸å…³** - å¯èƒ½ç›¸å…³ï¼Œéœ€è¦ä»”ç»†åˆ†æä¿®æ”¹å†…å®¹
3. **è¾ƒæ—©æäº¤ï¼ˆè¶…è¿‡1å‘¨ï¼‰**: âšª **ä½ç›¸å…³æ€§** - é™¤éæ˜¯é‡å¤§é‡æ„ï¼Œå¦åˆ™ä¸å¤ªå¯èƒ½æ˜¯ç›´æ¥åŸå› 

#### ç¬¬äº”æ­¥ï¼šåŸºäºæ—¶é—´ç›¸å…³æ€§æŸ¥çœ‹å…·ä½“ä¿®æ”¹å†…å®¹

**æ ¹æ®æäº¤æ—¶é—´çš„è¿œè¿‘ï¼Œä¼˜å…ˆæŸ¥çœ‹æœ€è¿‘çš„ä¿®æ”¹**ï¼š

```bash
# å¦‚æœæœ‰24å°æ—¶å†…çš„æäº¤ï¼Œé‡ç‚¹æŸ¥çœ‹è¿™äº›ä¿®æ”¹
git show HEAD -- path/to/component.test.ts | cat
git show HEAD -- path/to/component.ts | cat

# æŸ¥çœ‹æ¬¡æ–°çš„æäº¤ï¼ˆå¦‚æœæœ€æ–°æäº¤æ—¶é—´è¾ƒè¿œï¼‰
git show HEAD~1 -- path/to/component.ts | cat
git show path/to/component.ts < recent-commit-hash > -- | cat

# å¯¹æ¯”æœ€è¿‘ä¸¤æ¬¡æäº¤çš„å·®å¼‚
git diff HEAD~1 HEAD -- path/to/component.ts | cat
```

#### ç¬¬å…­æ­¥ï¼šåˆ†æä¿®æ”¹ä¸æµ‹è¯•å¤±è´¥çš„å…³ç³»

åŸºäºä¿®æ”¹è®°å½•å’Œæ—¶é—´ç›¸å…³æ€§åˆ¤æ–­ï¼š

1. **æœ€è¿‘ä¿®æ”¹äº†å®ç°ä»£ç **:

   ```bash
   # é‡ç‚¹æ£€æŸ¥å®ç°é€»è¾‘çš„å˜åŒ–
   git diff HEAD~1 path/to/component.ts | cat
   ```

   - å¾ˆå¯èƒ½æ˜¯å®ç°ä»£ç çš„å˜æ›´å¯¼è‡´æµ‹è¯•å¤±è´¥
   - æ£€æŸ¥å®ç°é€»è¾‘æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æµ‹è¯•æ˜¯å¦éœ€è¦ç›¸åº”æ›´æ–°

2. **æœ€è¿‘ä¿®æ”¹äº†æµ‹è¯•ä»£ç **:

   ```bash
   # é‡ç‚¹æ£€æŸ¥æµ‹è¯•é€»è¾‘çš„å˜åŒ–
   git diff HEAD~1 path/to/component.test.ts | cat
   ```

   - å¯èƒ½æ˜¯æµ‹è¯•æœ¬èº«å†™é”™äº†
   - æ£€æŸ¥æµ‹è¯•é€»è¾‘å’Œæ–­è¨€æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æµ‹è¯•æ˜¯å¦ç¬¦åˆå®ç°çš„é¢„æœŸè¡Œä¸º

3. **ä¸¤è€…éƒ½æœ‰æœ€è¿‘ä¿®æ”¹**:

   ```bash
   # å¯¹æ¯”ä¸¤ä¸ªæ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
   git log --pretty=format:"%ad %f" --date=iso -1 path/to/component.ts | cat
   git log --pretty=format:"%ad %f" --date=iso -1 path/to/component.test.ts | cat
   ```

   - éœ€è¦ç»¼åˆåˆ†æä¸¤è€…çš„ä¿®æ”¹
   - ç¡®å®šå“ªä¸ªä¿®æ”¹æ›´å¯èƒ½å¯¼è‡´é—®é¢˜
   - ä¼˜å…ˆæ£€æŸ¥æ—¶é—´æ›´è¿‘çš„ä¿®æ”¹

4. **éƒ½æ²¡æœ‰æœ€è¿‘ä¿®æ”¹**:
   - å¯èƒ½æ˜¯ä¾èµ–å˜æ›´æˆ–ç¯å¢ƒé—®é¢˜
   - æ£€æŸ¥ `package.json`ã€é…ç½®æ–‡ä»¶ç­‰çš„ä¿®æ”¹
   - æŸ¥çœ‹æ˜¯å¦æœ‰å…¨å±€æ€§çš„ä»£ç é‡æ„

#### ä¿®æ”¹è®°å½•æ£€æŸ¥ç¤ºä¾‹

```bash
# å®Œæ•´çš„æ£€æŸ¥æµç¨‹ç¤ºä¾‹
echo "=== æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹çŠ¶æ€ ==="
git status | grep component

echo "=== æ£€æŸ¥æœªæäº¤ä¿®æ”¹ ==="
git diff src/components/Button/index.test.tsx | cat
git diff src/components/Button/index.tsx | cat

echo "=== æ£€æŸ¥æäº¤å†å²å’Œæ—¶é—´ ==="
git log --pretty=format:"%h %ad %s" --date=relative -3 src/components/Button/index.test.tsx | cat
git log --pretty=format:"%h %ad %s" --date=relative -3 src/components/Button/index.tsx | cat

echo "=== æ ¹æ®æ—¶é—´ä¼˜å…ˆçº§æŸ¥çœ‹ä¿®æ”¹å†…å®¹ ==="
# å¦‚æœæœ‰24å°æ—¶å†…çš„æäº¤ï¼Œé‡ç‚¹æŸ¥çœ‹
git show HEAD -- src/components/Button/index.tsx | cat
```

## ğŸ—ƒï¸ æ•°æ®åº“ Model æµ‹è¯•æŒ‡å—

### æµ‹è¯•ç¯å¢ƒé€‰æ‹© ğŸ’¡

æ•°æ®åº“ Model å±‚é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶æ•°æ®åº“ç±»å‹ï¼Œåœ¨ä¸¤ç§æµ‹è¯•ç¯å¢ƒä¸‹æœ‰ä¸åŒçš„æ•°æ®åº“åç«¯ï¼šå®¢æˆ·ç«¯ç¯å¢ƒ (PGLite) å’Œ æœåŠ¡ç«¯ç¯å¢ƒ (PostgreSQL)

### âš ï¸ åŒç¯å¢ƒéªŒè¯è¦æ±‚

**å¯¹äºæ‰€æœ‰ Model æµ‹è¯•ï¼Œå¿…é¡»åœ¨ä¸¤ä¸ªç¯å¢ƒä¸‹éƒ½éªŒè¯é€šè¿‡**ï¼š

#### å®Œæ•´éªŒè¯æµç¨‹

```bash
# 1. å…ˆåœ¨å®¢æˆ·ç«¯ç¯å¢ƒæµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯ï¼‰
npx vitest run --config vitest.config.ts src/database/models/__tests__/myModel.test.ts

# 2. å†åœ¨æœåŠ¡ç«¯ç¯å¢ƒæµ‹è¯•ï¼ˆå…¼å®¹æ€§éªŒè¯ï¼‰
npx vitest run --config vitest.config.server.ts src/database/models/__tests__/myModel.test.ts
```

### åˆ›å»ºæ–° Model æµ‹è¯•çš„æœ€ä½³å®è·µ ğŸ“‹

#### 1. å‚è€ƒç°æœ‰å®ç°å’Œæµ‹è¯•æ¨¡æ¿

åˆ›å»ºæ–° Model æµ‹è¯•å‰ï¼Œ**å¿…é¡»å…ˆå‚è€ƒç°æœ‰çš„å®ç°æ¨¡å¼**ï¼š

- **Model å®ç°å‚è€ƒ**:
- **æµ‹è¯•æ¨¡æ¿å‚è€ƒ**:
- **å¤æ‚ç¤ºä¾‹å‚è€ƒ**:

#### 2. ç”¨æˆ·æƒé™æ£€æŸ¥ - å®‰å…¨ç¬¬ä¸€ ğŸ”’

è¿™æ˜¯**æœ€å…³é”®çš„å®‰å…¨è¦æ±‚**ã€‚æ‰€æœ‰æ¶‰åŠç”¨æˆ·æ•°æ®çš„æ“ä½œéƒ½å¿…é¡»åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥ï¼š

**âŒ é”™è¯¯ç¤ºä¾‹ - å­˜åœ¨å®‰å…¨æ¼æ´**:

```typescript
// å±é™©ï¼šç¼ºå°‘ç”¨æˆ·æƒé™æ£€æŸ¥ï¼Œä»»ä½•ç”¨æˆ·éƒ½èƒ½æ“ä½œä»»ä½•æ•°æ®
update = async (id: string, data: Partial<MyModel>) => {
  return this.db
    .update(myTable)
    .set(data)
    .where(eq(myTable.id, id)) // âŒ åªæ£€æŸ¥ IDï¼Œæ²¡æœ‰æ£€æŸ¥ userId
    .returning();
};
```

**âœ… æ­£ç¡®ç¤ºä¾‹ - å®‰å…¨çš„å®ç°**:

```typescript
// å®‰å…¨ï¼šå¿…é¡»åŒæ—¶åŒ¹é… ID å’Œ userId
update = async (id: string, data: Partial<MyModel>) => {
  return this.db
    .update(myTable)
    .set(data)
    .where(
      and(
        eq(myTable.id, id),
        eq(myTable.userId, this.userId), // âœ… ç”¨æˆ·æƒé™æ£€æŸ¥
      ),
    )
    .returning();
};
```

**å¿…é¡»è¿›è¡Œç”¨æˆ·æƒé™æ£€æŸ¥çš„æ–¹æ³•**ï¼š

- `update()` - æ›´æ–°æ“ä½œ
- `delete()` - åˆ é™¤æ“ä½œ
- `findById()` - æŸ¥æ‰¾ç‰¹å®šè®°å½•
- ä»»ä½•æ¶‰åŠç‰¹å®šè®°å½•çš„æŸ¥è¯¢æˆ–ä¿®æ”¹æ“ä½œ

#### 3. æµ‹è¯•æ–‡ä»¶ç»“æ„å’Œå¿…æµ‹åœºæ™¯

**åŸºæœ¬æµ‹è¯•ç»“æ„**:

```typescript
// @vitest-environment node
describe('MyModel', () => {
  describe('create', () => {
    it('should create a new record');
    it('should handle edge cases');
  });

  describe('queryAll', () => {
    it('should return records for current user only');
    it('should handle empty results');
  });

  describe('update', () => {
    it('should update own records');
    it('should NOT update other users records'); // ğŸ”’ å®‰å…¨æµ‹è¯•
  });

  describe('delete', () => {
    it('should delete own records');
    it('should NOT delete other users records'); // ğŸ”’ å®‰å…¨æµ‹è¯•
  });

  describe('user isolation', () => {
    it('should enforce user data isolation'); // ğŸ”’ æ ¸å¿ƒå®‰å…¨æµ‹è¯•
  });
});
```

**å¿…é¡»æµ‹è¯•çš„å®‰å…¨åœºæ™¯** ğŸ”’:

```typescript
it('should not update records of other users', async () => {
  // åˆ›å»ºå…¶ä»–ç”¨æˆ·çš„è®°å½•
  const [otherUserRecord] = await serverDB
    .insert(myTable)
    .values({ userId: 'other-user', data: 'original' })
    .returning();

  // å°è¯•æ›´æ–°å…¶ä»–ç”¨æˆ·çš„è®°å½•
  const result = await myModel.update(otherUserRecord.id, { data: 'hacked' });

  // åº”è¯¥è¿”å› undefined æˆ–ç©ºæ•°ç»„ï¼ˆå› ä¸ºæƒé™æ£€æŸ¥å¤±è´¥ï¼‰
  expect(result).toBeUndefined();

  // éªŒè¯åŸå§‹æ•°æ®æœªè¢«ä¿®æ”¹
  const unchanged = await serverDB.query.myTable.findFirst({
    where: eq(myTable.id, otherUserRecord.id),
  });
  expect(unchanged?.data).toBe('original'); // æ•°æ®åº”è¯¥ä¿æŒä¸å˜
});
```

#### 4. Mock å¤–éƒ¨ä¾èµ–æœåŠ¡

å¦‚æœ Model ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼ˆå¦‚ FileServiceï¼‰ï¼Œéœ€è¦æ­£ç¡® Mockï¼š

**è®¾ç½® Mock**:

```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨è®¾ç½® Mock
const mockGetFullFileUrl = vi.fn();
vi.mock('@/server/services/file', () => ({
  FileService: vi.fn().mockImplementation(() => ({
    getFullFileUrl: mockGetFullFileUrl,
  })),
}));

// åœ¨ beforeEach ä¸­é‡ç½®å’Œé…ç½® Mock
beforeEach(async () => {
  vi.clearAllMocks();
  mockGetFullFileUrl.mockImplementation((url: string) => `https://example.com/${url}`);
});
```

**éªŒè¯ Mock è°ƒç”¨**:

```typescript
it('should process URLs through FileService', async () => {
  // ... æµ‹è¯•é€»è¾‘

  // éªŒè¯ Mock è¢«æ­£ç¡®è°ƒç”¨
  expect(mockGetFullFileUrl).toHaveBeenCalledWith('expected-url');
  expect(mockGetFullFileUrl).toHaveBeenCalledTimes(1);
});
```

#### 5. æ•°æ®åº“çŠ¶æ€ç®¡ç†

**æ­£ç¡®çš„æ•°æ®æ¸…ç†æ¨¡å¼**:

```typescript
const userId = 'test-user';
const otherUserId = 'other-user';

beforeEach(async () => {
  // æ¸…ç†ç”¨æˆ·è¡¨ï¼ˆçº§è”åˆ é™¤ç›¸å…³æ•°æ®ï¼‰
  await serverDB.delete(users);

  // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
  await serverDB.insert(users).values([{ id: userId }, { id: otherUserId }]);
});

afterEach(async () => {
  // æ¸…ç†æµ‹è¯•æ•°æ®
  await serverDB.delete(users);
});
```

#### 6. æµ‹è¯•æ•°æ®ç±»å‹å’Œå¤–é”®çº¦æŸå¤„ç† âš ï¸

**å¿…é¡»ä½¿ç”¨ Schema å¯¼å‡ºçš„ç±»å‹**:

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ schema å¯¼å‡ºçš„ç±»å‹
import { NewGeneration, NewGenerationBatch } from '../../schemas';

const testBatch: NewGenerationBatch = {
  userId,
  generationTopicId: 'test-topic-id',
  provider: 'test-provider',
  model: 'test-model',
  prompt: 'Test prompt for image generation',
  width: 1024,
  height: 1024,
  config: {
    /* ... */
  },
};

const testGeneration: NewGeneration = {
  id: 'test-gen-id',
  generationBatchId: 'test-batch-id',
  asyncTaskId: null, // å¤„ç†å¤–é”®çº¦æŸ
  fileId: null, // å¤„ç†å¤–é”®çº¦æŸ
  seed: 12345,
  userId,
};
```

```typescript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç±»å‹å£°æ˜æˆ–ä½¿ç”¨é”™è¯¯ç±»å‹
const testBatch = {
  // ç¼ºå°‘ç±»å‹å£°æ˜
  generationTopicId: 'test-topic-id',
  // ...
};

const testGeneration = {
  // ç¼ºå°‘ç±»å‹å£°æ˜
  asyncTaskId: 'invalid-uuid', // å¤–é”®çº¦æŸé”™è¯¯
  fileId: 'non-existent-file', // å¤–é”®çº¦æŸé”™è¯¯
  // ...
};
```

**å¤–é”®çº¦æŸå¤„ç†ç­–ç•¥**:

1. **ä½¿ç”¨ null å€¼**: å¯¹äºå¯é€‰çš„å¤–é”®å­—æ®µï¼Œä½¿ç”¨ null é¿å…çº¦æŸé”™è¯¯
2. **åˆ›å»ºå…³è”è®°å½•**: å¦‚æœéœ€è¦æµ‹è¯•å…³è”å…³ç³»ï¼Œå…ˆåˆ›å»ºè¢«å¼•ç”¨çš„è®°å½•
3. **ç†è§£çº¦æŸå…³ç³»**: äº†è§£å“ªäº›å­—æ®µæœ‰å¤–é”®çº¦æŸï¼Œé¿å…å¼•ç”¨ä¸å­˜åœ¨çš„è®°å½•

```typescript
// å¤–é”®çº¦æŸå¤„ç†ç¤ºä¾‹
beforeEach(async () => {
  // æ¸…ç†æ•°æ®åº“
  await serverDB.delete(users);

  // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
  await serverDB.insert(users).values([{ id: userId }]);

  // å¦‚æœéœ€è¦æµ‹è¯•æ–‡ä»¶å…³è”ï¼Œåˆ›å»ºæ–‡ä»¶è®°å½•
  if (needsFileAssociation) {
    await serverDB.insert(files).values({
      id: 'test-file-id',
      userId,
      name: 'test.jpg',
      url: 'test-url',
      size: 1024,
      fileType: 'image/jpeg',
    });
  }
});
```

**æ’åºæµ‹è¯•çš„å¯é¢„æµ‹æ€§**:

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ˜ç¡®çš„æ—¶é—´æˆ³ç¡®ä¿æ’åºç»“æœå¯é¢„æµ‹
it('should find batches by topic id in correct order', async () => {
  const oldDate = new Date('2024-01-01T10:00:00Z');
  const newDate = new Date('2024-01-02T10:00:00Z');

  const batch1 = { ...testBatch, prompt: 'First batch', userId, createdAt: oldDate };
  const batch2 = { ...testBatch, prompt: 'Second batch', userId, createdAt: newDate };

  await serverDB.insert(generationBatches).values([batch1, batch2]);

  const results = await generationBatchModel.findByTopicId(testTopic.id);

  expect(results[0].prompt).toBe('Second batch'); // æœ€æ–°ä¼˜å…ˆ (desc order)
  expect(results[1].prompt).toBe('First batch');
});
```

```typescript
// âŒ é”™è¯¯ï¼šä¾èµ–æ•°æ®åº“çš„é»˜è®¤æ—¶é—´æˆ³ï¼Œç»“æœä¸å¯é¢„æµ‹
it('should find batches by topic id', async () => {
  const batch1 = { ...testBatch, prompt: 'First batch', userId };
  const batch2 = { ...testBatch, prompt: 'Second batch', userId };

  await serverDB.insert(generationBatches).values([batch1, batch2]);

  // æ’å…¥é¡ºåºå’Œæ•°æ®åº“æ—¶é—´æˆ³å¯èƒ½ä¸ä¸€è‡´ï¼Œå¯¼è‡´æµ‹è¯•ä¸ç¨³å®š
  const results = await generationBatchModel.findByTopicId(testTopic.id);
  expect(results[0].prompt).toBe('Second batch'); // å¯èƒ½å¤±è´¥
});
```

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ ğŸ’¡

#### é—®é¢˜ 1ï¼šæƒé™æ£€æŸ¥ç¼ºå¤±å¯¼è‡´å®‰å…¨æ¼æ´

**ç°è±¡**: æµ‹è¯•å¤±è´¥ï¼Œç”¨æˆ·èƒ½ä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æ•°æ® **è§£å†³**: åœ¨ Model çš„ `update` å’Œ `delete` æ–¹æ³•ä¸­æ·»åŠ  `and(eq(table.id, id), eq(table.userId, this.userId))`

#### é—®é¢˜ 2ï¼šMock æœªç”Ÿæ•ˆæˆ–éªŒè¯å¤±è´¥

**ç°è±¡**: `undefined is not a spy` é”™è¯¯ **è§£å†³**: æ£€æŸ¥ Mock è®¾ç½®ä½ç½®å’Œæ–¹å¼ï¼Œç¡®ä¿åœ¨æµ‹è¯•æ–‡ä»¶é¡¶éƒ¨è®¾ç½®ï¼Œåœ¨ `beforeEach` ä¸­é‡ç½®

#### é—®é¢˜ 3ï¼šæµ‹è¯•æ•°æ®æ±¡æŸ“

**ç°è±¡**: æµ‹è¯•é—´ç›¸äº’å½±å“ï¼Œç»“æœä¸ç¨³å®š **è§£å†³**: åœ¨ `beforeEach` å’Œ `afterEach` ä¸­æ­£ç¡®æ¸…ç†æ•°æ®åº“çŠ¶æ€

#### é—®é¢˜ 4ï¼šå¤–éƒ¨ä¾èµ–å¯¼è‡´æµ‹è¯•å¤±è´¥

**ç°è±¡**: å› ä¸ºçœŸå®çš„å¤–éƒ¨æœåŠ¡è°ƒç”¨å¯¼è‡´æµ‹è¯•ä¸ç¨³å®š **è§£å†³**: Mock æ‰€æœ‰å¤–éƒ¨ä¾èµ–ï¼Œä½¿æµ‹è¯•æ›´å¯æ§å’Œå¿«é€Ÿ

#### é—®é¢˜ 5ï¼šå¤–é”®çº¦æŸè¿åå¯¼è‡´æµ‹è¯•å¤±è´¥

**ç°è±¡**: `insert or update on table "xxx" violates foreign key constraint` **è§£å†³**:

- å°†å¯é€‰å¤–é”®å­—æ®µè®¾ä¸º `null` è€Œä¸æ˜¯æ— æ•ˆçš„å­—ç¬¦ä¸²å€¼
- æˆ–è€…å…ˆåˆ›å»ºè¢«å¼•ç”¨çš„è®°å½•ï¼Œå†åˆ›å»ºå½“å‰è®°å½•

```typescript
// âŒ é”™è¯¯ï¼šæ— æ•ˆçš„å¤–é”®å€¼
const testData = {
    asyncTaskId: 'invalid-uuid',  // è¡¨ä¸­ä¸å­˜åœ¨æ­¤è®°å½•
    fileId: 'non-existent-file',  // è¡¨ä¸­ä¸å­˜åœ¨æ­¤è®°å½•
};

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ null å€¼
const testData = {
    asyncTaskId: null,  // é¿å…å¤–é”®çº¦æŸ
    fileId: null,       // é¿å…å¤–é”®çº¦æŸ
};

// âœ… æˆ–è€…ï¼šå…ˆåˆ›å»ºè¢«å¼•ç”¨çš„è®°å½•
beforeEach(async () => {
    const [asyncTask] = await serverDB.insert(asyncTasks).values({
        id: 'valid-task-id',
        status: 'pending',
        type: 'generation',
    }).returning();

    const testData = {
        asyncTaskId: asyncTask.id,  // ä½¿ç”¨æœ‰æ•ˆçš„å¤–é”®å€¼
    };
});
```

#### é—®é¢˜ 6ï¼šæ’åºæµ‹è¯•ç»“æœä¸ä¸€è‡´

**ç°è±¡**: ç›¸åŒçš„æµ‹è¯•æœ‰æ—¶é€šè¿‡ï¼Œæœ‰æ—¶å¤±è´¥ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠæ’åºçš„æµ‹è¯• **è§£å†³**: ä½¿ç”¨æ˜ç¡®çš„æ—¶é—´æˆ³ï¼Œä¸è¦ä¾èµ–æ•°æ®åº“çš„é»˜è®¤æ—¶é—´æˆ³

```typescript
// âŒ é”™è¯¯ï¼šä¾èµ–æ’å…¥é¡ºåºå’Œé»˜è®¤æ—¶é—´æˆ³
await serverDB.insert(table).values([data1, data2]); // æ—¶é—´æˆ³ä¸å¯é¢„æµ‹

// âœ… æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šæ—¶é—´æˆ³
const oldDate = new Date('2024-01-01T10:00:00Z');
const newDate = new Date('2024-01-02T10:00:00Z');
await serverDB.insert(table).values([
  { ...data1, createdAt: oldDate },
  { ...data2, createdAt: newDate },
]);
```

#### é—®é¢˜ 7ï¼šMock éªŒè¯å¤±è´¥æˆ–è°ƒç”¨æ¬¡æ•°ä¸åŒ¹é…

**ç°è±¡**: `expect(mockFunction).toHaveBeenCalledWith(...)` å¤±è´¥ **è§£å†³**:

- æ£€æŸ¥ Mock å‡½æ•°çš„å®é™…è°ƒç”¨å‚æ•°å’ŒæœŸæœ›å‚æ•°æ˜¯å¦å®Œå…¨åŒ¹é…
- ç¡®è®¤ Mock åœ¨æ­£ç¡®çš„æ—¶æœºè¢«é‡ç½®å’Œé…ç½®
- ä½¿ç”¨ `toHaveBeenCalledTimes()` éªŒè¯è°ƒç”¨æ¬¡æ•°

```typescript
// åœ¨ beforeEach ä¸­æ­£ç¡®é…ç½® Mock
beforeEach(() => {
  vi.clearAllMocks(); // é‡ç½®æ‰€æœ‰ Mock

  mockGetFullFileUrl.mockImplementation((url: string) => `https://example.com/${url}`);
  mockTransformGeneration.mockResolvedValue({
    id: 'test-id',
    // ... å…¶ä»–å­—æ®µ
  });
});

// æµ‹è¯•ä¸­éªŒè¯ Mock è°ƒç”¨
it('should call FileService with correct parameters', async () => {
  await model.someMethod();

  // éªŒè¯è°ƒç”¨å‚æ•°
  expect(mockGetFullFileUrl).toHaveBeenCalledWith('expected-url');
  // éªŒè¯è°ƒç”¨æ¬¡æ•°
  expect(mockGetFullFileUrl).toHaveBeenCalledTimes(1);
});
```

### Model æµ‹è¯•æ£€æŸ¥æ¸…å• âœ…

åˆ›å»º Model æµ‹è¯•æ—¶ï¼Œè¯·ç¡®ä¿ä»¥ä¸‹å„é¡¹éƒ½å·²å®Œæˆï¼š

#### ğŸ”§ åŸºç¡€é…ç½®

- [ ] **åŒç¯å¢ƒéªŒè¯** - åœ¨å®¢æˆ·ç«¯ç¯å¢ƒ (vitest.config.ts) å’ŒæœåŠ¡ç«¯ç¯å¢ƒ (vitest.config.server.ts) ä¸‹éƒ½æµ‹è¯•é€šè¿‡
- [ ] å‚è€ƒäº† `_template.ts` å’Œç°æœ‰ Model çš„å®ç°æ¨¡å¼
- [ ] **ä½¿ç”¨æ­£ç¡®çš„ Schema ç±»å‹** - æµ‹è¯•æ•°æ®ä½¿ç”¨ `NewXxx` ç±»å‹å£°æ˜ï¼Œå¦‚ `NewGenerationBatch`ã€`NewGeneration`

#### ğŸ”’ å®‰å…¨æµ‹è¯•

- [ ] **æ‰€æœ‰æ¶‰åŠç”¨æˆ·æ•°æ®çš„æ“ä½œéƒ½åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥**
- [ ] åŒ…å«äº†ç”¨æˆ·æƒé™éš”ç¦»çš„å®‰å…¨æµ‹è¯•
- [ ] æµ‹è¯•äº†ç”¨æˆ·æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·æ•°æ®çš„åœºæ™¯

#### ğŸ—ƒï¸ æ•°æ®å¤„ç†

- [ ] **æ­£ç¡®å¤„ç†å¤–é”®çº¦æŸ** - ä½¿ç”¨ `null` å€¼æˆ–å…ˆåˆ›å»ºè¢«å¼•ç”¨è®°å½•
- [ ] **æ’åºæµ‹è¯•ä½¿ç”¨æ˜ç¡®æ—¶é—´æˆ³** - ä¸ä¾èµ–æ•°æ®åº“é»˜è®¤æ—¶é—´ï¼Œç¡®ä¿ç»“æœå¯é¢„æµ‹
- [ ] åœ¨ `beforeEach` å’Œ `afterEach` ä¸­æ­£ç¡®ç®¡ç†æ•°æ®åº“çŠ¶æ€
- [ ] æ‰€æœ‰æµ‹è¯•éƒ½èƒ½ç‹¬ç«‹è¿è¡Œä¸”äº’ä¸å¹²æ‰°

#### ğŸ­ Mock å’Œå¤–éƒ¨ä¾èµ–

- [ ] æ­£ç¡® Mock äº†å¤–éƒ¨ä¾èµ–æœåŠ¡ (å¦‚ FileServiceã€GenerationModel)
- [ ] åœ¨ `beforeEach` ä¸­é‡ç½®å’Œé…ç½® Mock
- [ ] éªŒè¯äº† Mock æœåŠ¡çš„è°ƒç”¨å‚æ•°å’Œæ¬¡æ•°
- [ ] æµ‹è¯•äº†å¤–éƒ¨æœåŠ¡é”™è¯¯åœºæ™¯çš„å¤„ç†

#### ğŸ“‹ æµ‹è¯•è¦†ç›–

- [ ] æµ‹è¯•è¦†ç›–äº†æ‰€æœ‰ä¸»è¦æ–¹æ³• (create, query, update, delete)
- [ ] æµ‹è¯•äº†è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯åœºæ™¯
- [ ] åŒ…å«äº†ç©ºç»“æœå¤„ç†çš„æµ‹è¯•
- [ ] **ç¡®è®¤ä¸¤ä¸ªç¯å¢ƒä¸‹çš„æµ‹è¯•ç»“æœä¸€è‡´**

#### ğŸš¨ å¸¸è§é—®é¢˜æ£€æŸ¥

- [ ] æ²¡æœ‰å¤–é”®çº¦æŸè¿åé”™è¯¯
- [ ] æ’åºæµ‹è¯•ç»“æœç¨³å®šå¯é¢„æµ‹
- [ ] Mock éªŒè¯æ— å¤±è´¥
- [ ] æ— æµ‹è¯•æ•°æ®æ±¡æŸ“é—®é¢˜

### å®‰å…¨è­¦å‘Š âš ï¸

**æ•°æ®åº“ Model å±‚æ˜¯å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿**ã€‚å¦‚æœ Model å±‚ç¼ºå°‘ç”¨æˆ·æƒé™æ£€æŸ¥ï¼š

1. **ä»»ä½•ç”¨æˆ·éƒ½èƒ½è®¿é—®å’Œä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æ•°æ®**
2. **å³ä½¿ä¸Šå±‚æœ‰æƒé™æ£€æŸ¥ï¼Œä¹Ÿå¯èƒ½è¢«ç»•è¿‡**
3. **å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ•°æ®æ³„éœ²å’Œå®‰å…¨äº‹æ•…**

å› æ­¤ï¼Œ**æ¯ä¸ªæ¶‰åŠç”¨æˆ·æ•°æ®çš„ Model æ–¹æ³•éƒ½å¿…é¡»åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥ï¼Œä¸”å¿…é¡»æœ‰å¯¹åº”çš„å®‰å…¨æµ‹è¯•æ¥éªŒè¯è¿™äº›æ£€æŸ¥çš„æœ‰æ•ˆæ€§**ã€‚

## ğŸ¯ æ€»ç»“

ä¿®å¤æµ‹è¯•æ—¶ï¼Œè®°ä½ä»¥ä¸‹å…³é”®ç‚¹ï¼š

- **ä½¿ç”¨æ­£ç¡®çš„å‘½ä»¤**: `npx vitest run --config [config-file]`
- **ç†è§£æµ‹è¯•æ„å›¾**: å…ˆè¯»æ‡‚æµ‹è¯•å†ä¿®å¤
- **æŸ¥çœ‹æœ€è¿‘ä¿®æ”¹**: æ£€æŸ¥ç›¸å…³æ–‡ä»¶çš„ git ä¿®æ”¹è®°å½•ï¼Œåˆ¤æ–­é—®é¢˜æ ¹æº
- **é€‰æ‹©æ­£ç¡®ç¯å¢ƒ**: å®¢æˆ·ç«¯æµ‹è¯•ç”¨ `vitest.config.ts`ï¼ŒæœåŠ¡ç«¯ç”¨ `vitest.config.server.ts`
- **ä¸“æ³¨å•ä¸€é—®é¢˜**: åªä¿®å¤å½“å‰çš„æµ‹è¯•å¤±è´¥
- **éªŒè¯ä¿®å¤ç»“æœ**: ç¡®ä¿ä¿®å¤åæµ‹è¯•é€šè¿‡ä¸”æ— å‰¯ä½œç”¨
- **æä¾›ä¿®å¤æ€»ç»“**: è¯´æ˜é”™è¯¯åŸå› å’Œä¿®å¤æ–¹æ³•
- **Model æµ‹è¯•å®‰å…¨ç¬¬ä¸€**: å¿…é¡»åŒ…å«ç”¨æˆ·æƒé™æ£€æŸ¥å’Œå¯¹åº”çš„å®‰å…¨æµ‹è¯•
- **Model åŒç¯å¢ƒéªŒè¯**: å¿…é¡»åœ¨ PGLite å’Œ PostgreSQL ä¸¤ä¸ªç¯å¢ƒä¸‹éƒ½éªŒè¯é€šè¿‡
