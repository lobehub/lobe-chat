# é›†æˆæµ‹è¯•æŒ‡å—

## æ¦‚è¿°

é›†æˆæµ‹è¯•éªŒè¯å¤šä¸ªæ¨¡å—ååŒå·¥ä½œçš„æ­£ç¡®æ€§ï¼Œç¡®ä¿å®Œæ•´çš„è°ƒç”¨é“¾è·¯ï¼ˆRouter â†’ Service â†’ Model â†’ Databaseï¼‰æ­£å¸¸è¿è¡Œã€‚

## ä¸ºä»€ä¹ˆéœ€è¦é›†æˆæµ‹è¯•ï¼Ÿ

å³ä½¿å•å…ƒæµ‹è¯•è¦†ç›–ç‡å¾ˆé«˜ï¼ˆ80%+ï¼‰ï¼Œä»å¯èƒ½å‡ºç°é›†æˆé—®é¢˜ï¼š

### å¸¸è§é—®é¢˜ç¤ºä¾‹

```typescript
// âŒ é—®é¢˜ï¼šå‚æ•°åœ¨è°ƒç”¨é“¾ä¸­ä¸¢å¤±
// Router å±‚
const messageId = await messageModel.create({
  content: 'test',
  sessionId: 'xxx',
  topicId: 'yyy',  // â† ä¼ å…¥äº† topicId
});

// Model å±‚ï¼ˆå‡è®¾å®ç°æœ‰é—®é¢˜ï¼‰
async create(data) {
  return this.db.insert(messages).values({
    content: data.content,
    sessionId: data.sessionId,
    // âŒ å¿˜è®°ä¼ é€’ topicId
  });
}

// ç»“æœï¼šå•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆå› ä¸º mock äº† Modelï¼‰ï¼Œä½†å®é™…è¿è¡Œæ—¶ topicId ä¸¢å¤±
```

### é›†æˆæµ‹è¯•èƒ½å‘ç°çš„é—®é¢˜

1. **å‚æ•°ä¼ é€’é—æ¼**: containerIdã€threadIdã€topicId ç­‰åœ¨è°ƒç”¨é“¾ä¸­ä¸¢å¤±
2. **æ•°æ®åº“çº¦æŸ**: å¤–é”®å…³ç³»ã€çº§è”åˆ é™¤ç­‰åœ¨ mock ä¸­æ— æ³•éªŒè¯
3. **äº‹åŠ¡å®Œæ•´æ€§**: è·¨è¡¨æ“ä½œçš„åŸå­æ€§
4. **æƒé™éªŒè¯**: è·¨ç”¨æˆ·è®¿é—®æ§åˆ¶
5. **çœŸå®åœºæ™¯**: æ¨¡æ‹Ÿç”¨æˆ·çš„å®Œæ•´æ“ä½œæµç¨‹

## è¿è¡Œé›†æˆæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
pnpm test:integration

# è¿è¡Œç‰¹å®šæ–‡ä»¶
pnpm vitest tests/integration/routers/message.integration.test.ts

# ç›‘å¬æ¨¡å¼
pnpm vitest tests/integration --watch

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test:integration --coverage
```

## ç›®å½•ç»“æ„

```
tests/integration/
â”œâ”€â”€ README.md                              # é›†æˆæµ‹è¯•è¯´æ˜
â”œâ”€â”€ setup.ts                               # é€šç”¨è®¾ç½®å’Œå·¥å…·å‡½æ•°
â””â”€â”€ routers/                               # Router å±‚é›†æˆæµ‹è¯•
    â”œâ”€â”€ message.integration.test.ts        # Message Router æµ‹è¯•
    â”œâ”€â”€ session.integration.test.ts        # Session Router æµ‹è¯•
    â”œâ”€â”€ topic.integration.test.ts          # Topic Router æµ‹è¯•
    â””â”€â”€ chat-flow.integration.test.ts      # å®Œæ•´èŠå¤©æµç¨‹æµ‹è¯•
```

## ç¼–å†™é›†æˆæµ‹è¯•

### åŸºæœ¬æ¨¡æ¿

```typescript
// @vitest-environment node
import { eq } from 'drizzle-orm';
import { afterEach, beforeEach, describe, expect, it } from 'vitest';

import { getTestDB } from '@/database/models/__tests__/_util';
import { messages, sessions, users } from '@/database/schemas';
import { LobeChatDatabase } from '@/database/type';
import { messageRouter } from '@/server/routers/lambda/message';

import { cleanupTestUser, createTestContext, createTestUser } from '../setup';

describe('Your Feature Integration Tests', () => {
  let serverDB: LobeChatDatabase;
  let userId: string;

  beforeEach(async () => {
    // 1. è·å–æµ‹è¯•æ•°æ®åº“
    serverDB = await getTestDB();

    // 2. åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    userId = await createTestUser(serverDB);

    // 3. å‡†å¤‡å…¶ä»–æµ‹è¯•æ•°æ®
    // ...
  });

  afterEach(async () => {
    // æ¸…ç†æµ‹è¯•æ•°æ®
    await cleanupTestUser(serverDB, userId);
  });

  it('should do something', async () => {
    // 1. åˆ›å»º tRPC caller
    const caller = messageRouter.createCaller(createTestContext(userId));

    // 2. æ‰§è¡Œæ“ä½œ
    const result = await caller.someMethod({
      /* params */
    });

    // 3. éªŒè¯ç»“æœ
    expect(result).toBeDefined();

    // 4. ğŸ”¥ å…³é”®ï¼šä»æ•°æ®åº“éªŒè¯
    const [dbRecord] = await serverDB.select().from(messages).where(eq(messages.id, result));

    expect(dbRecord).toMatchObject({
      // éªŒè¯æ‰€æœ‰å…³é”®å­—æ®µ
    });
  });
});
```

### æœ€ä½³å®è·µ

#### 1. æµ‹è¯•å®Œæ•´çš„è°ƒç”¨é“¾è·¯

```typescript
it('should create message with correct associations', async () => {
  const caller = messageRouter.createCaller(createTestContext(userId));

  // æ‰§è¡Œæ“ä½œ
  const messageId = await caller.createMessage({
    content: 'Test',
    sessionId: testSessionId,
    topicId: testTopicId,
  });

  // âœ… ä»æ•°æ®åº“éªŒè¯ï¼Œè€Œä¸æ˜¯åªéªŒè¯è¿”å›å€¼
  const [message] = await serverDB.select().from(messages).where(eq(messages.id, messageId));

  expect(message.sessionId).toBe(testSessionId);
  expect(message.topicId).toBe(testTopicId);
  expect(message.userId).toBe(userId);
});
```

#### 2. æµ‹è¯•çº§è”æ“ä½œ

```typescript
it('should cascade delete messages when session is deleted', async () => {
  const sessionCaller = sessionRouter.createCaller(createTestContext(userId));
  const messageCaller = messageRouter.createCaller(createTestContext(userId));

  // åˆ›å»º session å’Œ messages
  const sessionId = await sessionCaller.createSession({
    /* ... */
  });
  await messageCaller.createMessage({ sessionId /* ... */ });

  // åˆ é™¤ session
  await sessionCaller.removeSession({ id: sessionId });

  // âœ… éªŒè¯ç›¸å…³æ¶ˆæ¯ä¹Ÿè¢«åˆ é™¤
  const remainingMessages = await serverDB
    .select()
    .from(messages)
    .where(eq(messages.sessionId, sessionId));

  expect(remainingMessages).toHaveLength(0);
});
```

#### 3. æµ‹è¯•è·¨ Router åä½œ

```typescript
it('should handle complete chat flow', async () => {
  const sessionCaller = sessionRouter.createCaller(createTestContext(userId));
  const topicCaller = topicRouter.createCaller(createTestContext(userId));
  const messageCaller = messageRouter.createCaller(createTestContext(userId));

  // 1. åˆ›å»º session
  const sessionId = await sessionCaller.createSession({
    /* ... */
  });

  // 2. åˆ›å»º topic
  const topicId = await topicCaller.createTopic({ sessionId /* ... */ });

  // 3. åˆ›å»º message
  const messageId = await messageCaller.createMessage({
    sessionId,
    topicId,
    /* ... */
  });

  // âœ… éªŒè¯å®Œæ•´çš„å…³è”å…³ç³»
  const [message] = await serverDB.select().from(messages).where(eq(messages.id, messageId));

  expect(message.sessionId).toBe(sessionId);
  expect(message.topicId).toBe(topicId);
});
```

#### 4. æµ‹è¯•é”™è¯¯åœºæ™¯

```typescript
it('should prevent cross-user access', async () => {
  // ç”¨æˆ· A åˆ›å»º session
  const sessionId = await sessionRouter.createCaller(createTestContext(userA)).createSession({
    /* ... */
  });

  // ç”¨æˆ· B å°è¯•è®¿é—®
  const callerB = messageRouter.createCaller(createTestContext(userB));

  // âœ… åº”è¯¥æŠ›å‡ºé”™è¯¯
  await expect(
    callerB.createMessage({
      sessionId,
      content: 'Unauthorized',
    }),
  ).rejects.toThrow();
});
```

#### 5. æµ‹è¯•å¹¶å‘åœºæ™¯

```typescript
it('should handle concurrent operations', async () => {
  const caller = messageRouter.createCaller(createTestContext(userId));

  // å¹¶å‘åˆ›å»ºå¤šä¸ªæ¶ˆæ¯
  const promises = Array.from({ length: 10 }, (_, i) =>
    caller.createMessage({
      content: `Message ${i}`,
      sessionId: testSessionId,
    }),
  );

  const messageIds = await Promise.all(promises);

  // âœ… éªŒè¯æ‰€æœ‰æ¶ˆæ¯éƒ½åˆ›å»ºæˆåŠŸä¸”å”¯ä¸€
  expect(messageIds).toHaveLength(10);
  expect(new Set(messageIds).size).toBe(10);
});
```

### æ•°æ®éš”ç¦»

æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åº”è¯¥ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•ï¼š

```typescript
beforeEach(async () => {
  // ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºæ–°çš„æ•°æ®
  userId = await createTestUser(serverDB);
  testSessionId = await createTestSession(serverDB, userId);
});

afterEach(async () => {
  // æ¸…ç†æµ‹è¯•æ•°æ®
  await cleanupTestUser(serverDB, userId);
});
```

### æµ‹è¯•å‘½å

ä½¿ç”¨æ¸…æ™°çš„å‘½åæè¿°æµ‹è¯•æ„å›¾ï¼š

```typescript
// âœ… å¥½çš„å‘½å
it('should create message with correct sessionId and topicId');
it('should cascade delete messages when session is deleted');
it('should prevent cross-user access to messages');

// âŒ ä¸å¥½çš„å‘½å
it('test message creation');
it('test delete');
```

## ä¸å•å…ƒæµ‹è¯•çš„åŒºåˆ«

| ç»´åº¦      | å•å…ƒæµ‹è¯•      | é›†æˆæµ‹è¯•    |
| ------- | --------- | ------- |
| **èŒƒå›´**  | å•ä¸ªå‡½æ•° / ç±»  | å¤šä¸ªæ¨¡å—åä½œ  |
| **ä¾èµ–**  | Mock å¤–éƒ¨ä¾èµ– | ä½¿ç”¨çœŸå®ä¾èµ–  |
| **æ•°æ®åº“** | Mock      | çœŸå®æµ‹è¯•æ•°æ®åº“ |
| **é€Ÿåº¦**  | å¿«ï¼ˆæ¯«ç§’çº§ï¼‰    | æ…¢ï¼ˆç§’çº§ï¼‰   |
| **æ•°é‡**  | å¤šï¼ˆ60%ï¼‰    | å°‘ï¼ˆ30%ï¼‰  |
| **ç›®çš„**  | éªŒè¯é€»è¾‘æ­£ç¡®æ€§   | éªŒè¯é›†æˆæ­£ç¡®æ€§ |

## æµ‹è¯•é‡‘å­—å¡”

```
       /\
      /E2E\        â† 10% (å…³é”®ä¸šåŠ¡æµç¨‹)
     /------\
    /  é›†æˆ  \      â† 30% (API é›†æˆæµ‹è¯•) â­ æœ¬æŒ‡å—é‡ç‚¹
   /----------\
  / å•å…ƒæµ‹è¯•   \    â† 60% (å·²æœ‰ 80%+)
 /--------------\
```

## è¦†ç›–ç›®æ ‡

### ä¼˜å…ˆçº§ P0ï¼ˆå¿…é¡»è¦†ç›–ï¼‰

- âœ… è·¨å±‚çº§çš„ ID ä¼ é€’ï¼ˆsessionIdã€topicIdã€containerIdã€threadIdï¼‰
- âœ… æƒé™éªŒè¯ï¼ˆç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æºï¼‰
- âœ… çº§è”åˆ é™¤ï¼ˆåˆ é™¤ session æ—¶ç›¸å…³æ•°æ®ä¹Ÿåˆ é™¤ï¼‰
- âœ… å¤–é”®çº¦æŸï¼ˆä¸èƒ½åˆ›å»ºä¸å­˜åœ¨çš„å…³è”ï¼‰

### ä¼˜å…ˆçº§ P1ï¼ˆåº”è¯¥è¦†ç›–ï¼‰

- å¹¶å‘åœºæ™¯ï¼ˆå¤šä¸ªè¯·æ±‚åŒæ—¶æ“ä½œï¼‰
- åˆ†é¡µæŸ¥è¯¢ï¼ˆæ­£ç¡®çš„æ•°æ®åˆ†é¡µï¼‰
- æœç´¢åŠŸèƒ½ï¼ˆå…³é”®è¯æœç´¢ï¼‰
- æ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡åˆ›å»º / åˆ é™¤ï¼‰

### ä¼˜å…ˆçº§ P2ï¼ˆå¯ä»¥è¦†ç›–ï¼‰

- ç»Ÿè®¡åŠŸèƒ½ï¼ˆè®¡æ•°ã€æ’åï¼‰
- å¤æ‚æŸ¥è¯¢ï¼ˆå¤šæ¡ä»¶ç­›é€‰ï¼‰
- æ€§èƒ½æµ‹è¯•ï¼ˆå¤§é‡æ•°æ®åœºæ™¯ï¼‰

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æµ‹è¯•æ•°æ®åº“çŠ¶æ€

```typescript
it('debug test', async () => {
  // æ‰§è¡Œæ“ä½œ
  await caller.createMessage({
    /* ... */
  });

  // æ‰“å°æ•°æ®åº“çŠ¶æ€
  const allMessages = await serverDB.select().from(messages);
  console.log('All messages:', allMessages);
});
```

### 2. ä½¿ç”¨ Drizzle Studio

```bash
# å¯åŠ¨ Drizzle Studio æŸ¥çœ‹æµ‹è¯•æ•°æ®åº“
pnpm db:studio
```

### 3. ä¿ç•™æµ‹è¯•æ•°æ®

```typescript
afterEach(async () => {
  // ä¸´æ—¶æ³¨é‡Šæ‰æ¸…ç†ä»£ç ï¼Œä¿ç•™æ•°æ®ç”¨äºè°ƒè¯•
  // await cleanupTestUser(serverDB, userId);
});
```

## å¸¸è§é—®é¢˜

### Q: é›†æˆæµ‹è¯•å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

A:

1. åªæµ‹è¯•å…³é”®è·¯å¾„ï¼Œä¸è¦è¿‡åº¦æµ‹è¯•
2. ä½¿ç”¨ `test.concurrent` å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹çš„æµ‹è¯•
3. ä¼˜åŒ–æµ‹è¯•æ•°æ®å‡†å¤‡ï¼Œé¿å…é‡å¤åˆ›å»º

### Q: æµ‹è¯•ä¹‹é—´ç›¸äº’å½±å“æ€ä¹ˆåŠï¼Ÿ

A:

1. ç¡®ä¿æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„ userId
2. åœ¨ `afterEach` ä¸­å½»åº•æ¸…ç†æ•°æ®
3. ä½¿ç”¨äº‹åŠ¡éš”ç¦»ï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒï¼‰

### Q: å¦‚ä½•æµ‹è¯•éœ€è¦è®¤è¯çš„ APIï¼Ÿ

A: ä½¿ç”¨ `createTestContext(userId)` åˆ›å»ºå¸¦è®¤è¯ä¿¡æ¯çš„ä¸Šä¸‹æ–‡ï¼š

```typescript
const caller = messageRouter.createCaller(createTestContext(userId));
```

## å‚è€ƒèµ„æ–™

- [Vitest æ–‡æ¡£](https://vitest.dev/)
- [Drizzle ORM æ–‡æ¡£](https://orm.drizzle.team/)
- [tRPC æµ‹è¯•æŒ‡å—](https://trpc.io/docs/server/testing)
- [æµ‹è¯•é‡‘å­—å¡”](https://martinfowler.com/articles/practical-test-pyramid.html)

## è´¡çŒ®

æ¬¢è¿è¡¥å……æ›´å¤šé›†æˆæµ‹è¯•ç”¨ä¾‹ï¼è¯·å‚è€ƒç°æœ‰æµ‹è¯•æ–‡ä»¶çš„é£æ ¼ã€‚
